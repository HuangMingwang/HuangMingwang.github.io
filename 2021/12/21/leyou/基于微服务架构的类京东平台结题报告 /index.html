<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Leyou结题报告 | MingwHuang's Blog</title><meta name="keywords" content="Leyou"><meta name="author" content="MingwHuang"><meta name="copyright" content="MingwHuang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基于微服务架构的类京东电商平台结题报告一、绪论近年来，世界经济正向数字化转型，大力发展数字经济成为全球共识。党的十九大报告明确提出要建设“数字中国”“网络强国”，我国数字经济发展进入新阶段，市场规模位居全球第二，数字经济与实体经济深度融合，有力促进了供给侧结构性改革。电子商务是数字经济的重要组成部分，是数字经济最活跃、最集中的表现形式之一。 近年来，电子商务规模逐步扩大，已经深入到我们生活的各个角">
<meta property="og:type" content="article">
<meta property="og:title" content="Leyou结题报告">
<meta property="og:url" content="http://mingwzi.cn/2021/12/21/leyou/%E5%9F%BA%E4%BA%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%B1%BB%E4%BA%AC%E4%B8%9C%E5%B9%B3%E5%8F%B0%E7%BB%93%E9%A2%98%E6%8A%A5%E5%91%8A%20/index.html">
<meta property="og:site_name" content="MingwHuang&#39;s Blog">
<meta property="og:description" content="基于微服务架构的类京东电商平台结题报告一、绪论近年来，世界经济正向数字化转型，大力发展数字经济成为全球共识。党的十九大报告明确提出要建设“数字中国”“网络强国”，我国数字经济发展进入新阶段，市场规模位居全球第二，数字经济与实体经济深度融合，有力促进了供给侧结构性改革。电子商务是数字经济的重要组成部分，是数字经济最活跃、最集中的表现形式之一。 近年来，电子商务规模逐步扩大，已经深入到我们生活的各个角">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046012.jpg">
<meta property="article:published_time" content="2021-12-21T13:17:14.000Z">
<meta property="article:modified_time" content="2022-02-22T13:55:23.938Z">
<meta property="article:author" content="MingwHuang">
<meta property="article:tag" content="Leyou">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046012.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://mingwzi.cn/2021/12/21/leyou/%E5%9F%BA%E4%BA%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%B1%BB%E4%BA%AC%E4%B8%9C%E5%B9%B3%E5%8F%B0%E7%BB%93%E9%A2%98%E6%8A%A5%E5%91%8A%20/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Leyou结题报告',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-22 21:55:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272113875.JPG" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046012.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">MingwHuang's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Leyou结题报告</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-21T13:17:14.000Z" title="发表于 2021-12-21 21:17:14">2021-12-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-22T13:55:23.938Z" title="更新于 2022-02-22 21:55:23">2022-02-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Leyou/">Leyou</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Leyou结题报告"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基于微服务架构的类京东电商平台结题报告"><a href="#基于微服务架构的类京东电商平台结题报告" class="headerlink" title="基于微服务架构的类京东电商平台结题报告"></a>基于微服务架构的类京东电商平台结题报告</h1><h1 id="一、绪论"><a href="#一、绪论" class="headerlink" title="一、绪论"></a>一、绪论</h1><p>近年来，世界经济正向数字化转型，大力发展数字经济成为全球共识。党的十九大报告明确提出要建设“数字中国”“网络强国”，我国数字经济发展进入新阶段，市场规模位居全球第二，数字经济与实体经济深度融合，有力促进了供给侧结构性改革。电子商务是数字经济的重要组成部分，是数字经济最活跃、最集中的表现形式之一。</p>
<p>近年来，电子商务规模逐步扩大，已经深入到我们生活的各个角落，特别是一些全民参与的购物庆典，其典型代表就是每年一度的双十一、6.18等活动。</p>
<p>2020双11开场30分钟，创造<strong>每秒交易峰值58.3万笔</strong>。</p>
<p>2021年，阿里自研数据库OceanBase的峰值达到9200万次。</p>
<p>如此高的并发，对技术有很高的要求：</p>
<ul>
<li>技术范围广</li>
<li>技术新</li>
<li>要求双高：<ul>
<li>高并发（分布式、静态化技术、CDN服务、缓存技术、异步并发、池化、队列）</li>
<li>高可用（集群、负载均衡、限流、降级、熔断）</li>
</ul>
</li>
<li>数据量大</li>
<li>业务复杂</li>
</ul>
<p>因此，即使刚开始公司的规模不大，并发量很小，我们的商城项目也不能再基于传统的单库单表的方式的搭建，而应该基于微服务架构搭箭，这样以后业务量上涨只需动态增加服务器数量，而不需要重构项目。</p>
<h1 id="二、相关技术介绍"><a href="#二、相关技术介绍" class="headerlink" title="二、相关技术介绍"></a>二、相关技术介绍</h1><h2 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h2><p>Spring Boot 是所有基于 Spring 开发的项目的起点。Spring Boot 的设计是为了让你尽可能快的跑起来 Spring 应用程序并且尽可能减少你的配置文件。简单来说就是SpringBoot其实不是什么新的框架，它默认配置了很多框架的使用方式，就像maven整合了所有的jar包，spring boot整合了所有的框架。</p>
<h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><p>SpringCloud是微服务架构中的集成，将一系列优秀的组件进行了整合。基于SpringBoot构建。</p>
<h2 id="Mybatis-Plus"><a href="#Mybatis-Plus" class="headerlink" title="Mybatis Plus"></a>Mybatis Plus</h2><p>一个 MyBatis的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p>
<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p>MySQL是一个开放源码的小型关联式数据库管理系统，开发者为瑞典MySQL AB公司。目前MySQL被广泛地应用在Internet上的中小型网站中。由于其体积小、速度快、总体拥有成本低，尤其是开放源码这一特点，许多中小型网站为了降低网站总体拥有成本而选择了MySQL作为网站数据库。</p>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><p>Redis 是完全开源的，遵守 BSD 协议，是一个高性能的 key-value 数据库。</p>
<p>Redis 与其他 key - value 缓存产品有以下三个特点：</p>
<ul>
<li>Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。</li>
<li>Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份。</li>
</ul>
<h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><p>MongoDB 是一个开源的，高性能，无模式（或者说是模式自由），使用 C++ 语言编写的面向文档的数据库。正因为 MongoDB 是面向文档的，所以它可以管理类似 JSON 的文档集合。又因为数据可以被嵌套到复杂的体系中并保持可以查询可索引，这样一来，应用程序便可以以一种更加自然的方式来为数据建模。</p>
<p>Mongo 适合用于以下场景：</p>
<ul>
<li>网站数据：Mongo非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性。</li>
<li>缓存：由于性能很高，Mongo也适合作为信息基础设施的缓存层。在系统重启之后，由Mongo搭建的持久化缓存层可以避免下层的数据源过载。</li>
<li>大尺寸，低价值的数据：使用传统的关系型数据库存储一些数据时可能会比较昂贵，在此之前，很多时候程序员往往会选择传统的文件进行存储。</li>
<li>高伸缩性的场景：Mongo非常适合由数十或数百台服务器组成的数据库。Mongo的路线图中已经包含对MapReduce引擎的内置支持。</li>
<li>用于对象及JSON数据的存储：Mongo的BSON数据格式非常适合文档化格式的存储及查询。</li>
</ul>
<h2 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h2><p><strong>Elasticsearch</strong>是一个非常强大的搜索引擎。它目前被广泛地使用于各个IT公司。Elasticsearch是由Elastic公司创建并开源维护的。它的开源代码位于 <a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch%E3%80%82">github.com&#x2F;elastic&#x2F;ela…</a> 同时，Elastic公司也拥有<a target="_blank" rel="noopener" href="https://github.com/elastic/logstash">Logstash</a>及<a target="_blank" rel="noopener" href="https://github.com/elastic/kibana">Kibana</a>开源项目。这个三个开源项目组合在一起，就形成了 <strong>ELK</strong> 软件栈。他们三个共同形成了一个强大的生态圈。简单地说，<strong>L</strong>ogstash负责数据的采集，处理（丰富数据，数据转型等），<strong>K</strong>ibana负责数据展，分析及管理。<strong>E</strong>lasticsearch处于最核心的位置，它可以帮我们对数据进行快速地搜索及分析。</p>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><p>消息队列提供一个异步通信机制，消息的发送者不必一直等待到消息被成功处理才返回，而是立即返回。消息中间件负责处理网络通信，如果网络连接不可用，消息被暂存于队列当中，当网络畅通的时候在将消息转发给相应的应用程序或者服务，当然前提是这些服务订阅了该队列。如果在商品服务和订单服务之间使用消息中间件，既可以提高并发量，又降低服务之间的耦合度。</p>
<p>RabbitMQ就是这样一款我们苦苦追寻的消息队列。RabbitMQ是一个开源的消息代理的队列服务器，用来通过普通协议在完全不同的应用之间共享数据。</p>
<p>RabbitMQ是使用Erlang语言来编写的，并且RabbitMQ是基于AMQP协议的。Erlang语言在数据交互方面性能优秀，有着和原生Socket一样的延迟，这也是RabbitMQ高性能的原因所在。可谓“人如其名”，RabbitMQ像兔子一样迅速。</p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>nginx是一个<strong>高性能的HTTP</strong>和<strong>反向代理服务器</strong>,其特点是占用内存少,并发能力强.</p>
<h2 id="Openresty"><a href="#Openresty" class="headerlink" title="Openresty"></a>Openresty</h2><p>OpenResty是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<p>OpenResty通过汇聚各种设计精良的 Nginx 模块（主要由 OpenResty 团队自主开发），从而将 Nginx 有效地变成一个强大的通用 Web 应用平台。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统。</p>
<p>OpenResty的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I&#x2F;O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。</p>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p>JSON Web Token (JWT)是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息。 该信息可以被验证和信任，因为它是数字签名的。</p>
<h2 id="Canal"><a href="#Canal" class="headerlink" title="Canal"></a>Canal</h2><p> Canal是阿里巴巴旗下的一款开源项目，纯Java开发。 基于数据库增量日志解析，提供增量数据订阅&amp;消费，目前主要支持了MySQL（也支持mariaDB）。</p>
<h2 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h2><p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>
<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>Docker 是一个开放源代码软件项目，项目主要代码在2013年开源于 <a target="_blank" rel="noopener" href="https://github.com/moby/moby">GitHub</a>。它是云服务技术上的一次创新，让应用程序布署在软件容器下的工作可以自动化进行，借此在 Linux 操作系统上，提供一个额外的软件抽象层，以及操作系统层虚拟化的自动管理机制。</p>
<p>Docker 利用 Linux 核心中的资源分脱机制，例如 cgroups，以及 Linux 核心名字空间（name space），来创建独立的软件容器（containers），属于操作系统层面的虚拟化技术。由于隔离的进程独立于宿主和其它的隔离的进程，因此也称其为容器。Docker 在容器的基础上进行了进一步的封装，从文件系统、网络互联到进程隔离等等，极大的简化了容器的创建和维护，使得其比虚拟机技术更为轻便、快捷。Docker 可以在单一 Linux 实体下运作，避免因为创建一个虚拟机而造成的额外负担。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120457.png" alt="截屏2021-07-03 上午9.41.39"></p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120458.png" alt="截屏2021-07-03 上午9.41.47"></p>
<h2 id="GrayLog"><a href="#GrayLog" class="headerlink" title="GrayLog"></a>GrayLog</h2><p><strong>Enterprise Log Management for All</strong>。<br>一个具有报警选项的可插入日志和事件分析服务器。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120459.png" alt="截屏2021-07-03 上午9.47.48"></p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120460.png" alt="截屏2021-07-03 上午9.48.00"></p>
<h2 id="Skywalking"><a href="#Skywalking" class="headerlink" title="Skywalking"></a>Skywalking</h2><p>SkyWalking是分布式系统的应用程序性能监视工具，专为微服务、云原生架构和基于容器（Docker、K8S、Mesos）架构而设计</p>
<p>SkyWalking是观察性分析平台和应用性能管理系统。提供分布式追踪、服务网格遥测分析、度量聚合和可视化一体化解决方案</p>
<p>SkyWalking是一个开源APM系统，包括对Cloud Native体系结构中的分布式系统的监视，跟踪，诊断功能。 核心功能如下。</p>
<ul>
<li>服务，服务实例，端点指标分析</li>
<li>根本原因分析</li>
<li>服务拓扑图分析</li>
<li>服务，服务实例和端点依赖关系分析</li>
<li>检测到慢速服务和端点</li>
<li>性能优化</li>
<li>分布式跟踪和上下文传播</li>
<li>数据库访问指标。 检测慢速数据库访问语句（包括SQL语句）。</li>
<li>报警</li>
</ul>
<p>SkyWalking支持从多种来源和多种格式收集遥测（跟踪和度量）数据，包括</p>
<ul>
<li>SkyWalking格式的Java，.NET Core，NodeJS和PHP自动仪器代理</li>
<li>SkyWalking格式的手动仪器Go代理。</li>
<li>Istio遥测格式</li>
<li>由Istio控制的服务网格中的Envoy gRPC访问日志服务（ALS）格式</li>
<li>特使指标服务格式。</li>
<li>Zipkin v1 &#x2F; v2格式。</li>
<li>Jaeger gRPC格式。</li>
</ul>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120461.png" alt="image-20210703095106687"></p>
<h2 id="Vue-js"><a href="#Vue-js" class="headerlink" title="Vue.js"></a>Vue.js</h2><p>Vue.js是一套用于构建用户界面的渐进式框架。与其它大型框架不同的是，Vue 被设计为可以自底向上逐层应用。Vue 的核心库只关注视图层，不仅易于上手，还便于与第三方库或既有项目整合。Vue拥有比react更简单好用的双向数据绑定。</p>
<h2 id="Vue-CLI-脚手架"><a href="#Vue-CLI-脚手架" class="headerlink" title="Vue CLI 脚手架"></a>Vue CLI 脚手架</h2><p>Vue CLI 脚手架可以快速生成前端项目的文件配置，其致力于将 Vue 生态中的工具基础标准化，这样开发者可以专注在撰写应用上，而不必花时间去纠结配置的问题。与此同时，它也为每个工具提供了调整配置的灵活性。</p>
<h2 id="element-UI-Vant-组件库"><a href="#element-UI-Vant-组件库" class="headerlink" title="element-UI + Vant 组件库"></a>element-UI + Vant 组件库</h2><p>  由于前端开发的模块化、组件化的兴起，导致了很多开源组件库的产生。组件库就是一套为开发者、设计师和产品经理准备的基于 Vue 或 react 的桌面端组件的集合，它可以大大加快程序员的开发效率。</p>
<h2 id="Axios"><a href="#Axios" class="headerlink" title="Axios"></a>Axios</h2><p>基于promise用于浏览器和node.js的http客户端，axios 是对 ajax 技术的封装，主要是前端用来与服务器进行数据交换使用。</p>
<h2 id="Vue-Router"><a href="#Vue-Router" class="headerlink" title="Vue Router"></a>Vue Router</h2><p>Vue Router 是 <a target="_blank" rel="noopener" href="http://cn.vuejs.org/">Vue.js </a>官方的路由管理器。通过Vue Router 在路由器配置中建立组件与路由路径的一一对应，并通过路由器监听器监听路由路径的改变，以此达到切换组件的功能。</p>
<h2 id="Vuex"><a href="#Vuex" class="headerlink" title="Vuex"></a>Vuex</h2><p>Vuex 是一个专为 Vue.js 应用程序开发的状态管理模式。它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。Vuex 也集成到 Vue 的官方调试工具 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-devtools">devtools extension </a>，提供了诸如零配置的 time-travel 调试、状态快照导入导出等高级调试功能。</p>
<h1 id="三、需求分析"><a href="#三、需求分析" class="headerlink" title="三、需求分析"></a>三、需求分析</h1><p>类京东的电商平台是一个典型的B2C（Business to Customer）类型的电子商务平台。既要面向用户，又要面向管理员。就面向用户而言，系统应实现注册、登陆、浏览商品、搜索商品、产生订单，查看订单，查看个人信息等功能；就面向管理员而言，系统应实现商品管理、会员管理、销售管理和权限管理等功能。虽然刚开始的并发量不大，但是考虑到以后的业务扩展以及用户数的激增，我们选择采用微服务架构才搭建该项目，在微服务架构下，我们需要解决分布式事务问题，以及设计分布式锁，确保整个平台安全可靠的运行，不会出现库存超卖等情况。</p>
<h1 id="四、项目主要模块设计"><a href="#四、项目主要模块设计" class="headerlink" title="四、项目主要模块设计"></a>四、项目主要模块设计</h1><h2 id="项目总体结构设计"><a href="#项目总体结构设计" class="headerlink" title="项目总体结构设计"></a>项目总体结构设计</h2><p>本项目可分为前端应用和后台服务三大模块。</p>
<ul>
<li><p>前端应用可分为基于H5的前台门户服务和基于SPA的后台管理页面，前台门户服务主要用来和用户交互，用户浏览商品，购买商品等等，后台管理页面主要用来和管理员交互，主要可以进行商品管理、会员管理、销售管理和权限管理。</p>
</li>
<li><p>后台服务可分为接入层，网关层，服务层，基础服务和数据层</p>
</li>
</ul>
<p>业务架构设计如图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120462.png" alt="image-20210703154549744"></p>
<p>项目技术架构设计如图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120464.png" alt="image-20210703153352619"></p>
<p>类图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120465.png" alt="image-20210704195748193"></p>
<h2 id="前台应用详细设计"><a href="#前台应用详细设计" class="headerlink" title="前台应用详细设计"></a>前台应用详细设计</h2><h3 id="前台门户服务"><a href="#前台门户服务" class="headerlink" title="前台门户服务"></a>前台门户服务</h3><h4 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈:"></a>技术栈:</h4><p>Vue框架 + ElementUI + Vant + axios + VueRouter路由 + Vue CLI脚手架</p>
<h4 id="项目功能模块"><a href="#项目功能模块" class="headerlink" title="项目功能模块"></a>项目功能模块</h4><p>登录与注册功能</p>
<p>①页面使用了element-ui的Dialog组件实现弹出对话框的效果，登录按钮设置在App.vue根组件，通过vuex中的showLogin状态控制登录框是否显示。</p>
<p>②当用户登录失败(用户输入的账号不存在)，提示用户先进行注册账号，并切换登录组件为注册组件。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120466.jpg" alt="img"> </p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120467.jpg" alt="img"> </p>
<h4 id="首页展示"><a href="#首页展示" class="headerlink" title="首页展示"></a>首页展示</h4><p>①首页主要是对商品的展示，有轮播图展示推荐的商品，分类别对热门商品进行展示。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120468.jpg" alt="img"> </p>
<h4 id="账号管理–待发货"><a href="#账号管理–待发货" class="headerlink" title="账号管理–待发货"></a>账号管理–待发货</h4><p>①通过服务器发来的订单数据，并通过判断isSend字段判断订单是否发货，将未发货订单全部放入一个数组中并将订单(图片、标题、价格、时间)渲染到组件上。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120469.jpg" alt="img"> </p>
<h4 id="账号管理–我的收藏"><a href="#账号管理–我的收藏" class="headerlink" title="账号管理–我的收藏"></a>账号管理–我的收藏</h4><p>①将服务器传来的用户收藏商品数据保存在数组中，并通过V-for 循环渲染在收藏组件中。</p>
<p>②效果图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120470.jpg" alt="img"> </p>
<h4 id="个人信息–地址管理"><a href="#个人信息–地址管理" class="headerlink" title="个人信息–地址管理"></a>个人信息–地址管理</h4><p>①将服务器传来的用户已有地址数据循环渲染出来，并增加一个 添加新地址功能，当用户添加新地址后，前端将新添加的数据对象通过axios 请求发送给服务器保存起来。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120471.jpg" alt="img"> </p>
<h4 id="热门推荐：将用户可能喜欢的产品展示在用户推荐列表中"><a href="#热门推荐：将用户可能喜欢的产品展示在用户推荐列表中" class="headerlink" title="热门推荐：将用户可能喜欢的产品展示在用户推荐列表中"></a>热门推荐：将用户可能喜欢的产品展示在用户推荐列表中</h4><p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120472.jpg" alt="img"></p>
<h3 id="管理员页面服务"><a href="#管理员页面服务" class="headerlink" title="管理员页面服务"></a>管理员页面服务</h3><h4 id="管理员页面服务采用前后端分离开发，主要完成的功能有："><a href="#管理员页面服务采用前后端分离开发，主要完成的功能有：" class="headerlink" title="管理员页面服务采用前后端分离开发，主要完成的功能有："></a>管理员页面服务采用前后端分离开发，主要完成的功能有：</h4><ul>
<li><p>登录功能页面</p>
</li>
<li><p>商品管理：包括商品分类管理，品牌管理，商品列表、商品规格信息管理</p>
</li>
<li><p>销售管理：包括交易统计、订单管理、物流管理、促销管理。</p>
</li>
<li><p>会员管理：包括会员统计、会员管理。</p>
</li>
<li><p>权限管理：包括权限管理、角色管理、人员管理、服务管理。</p>
</li>
</ul>
<h4 id="电商后台管理系统是基于Vue-技术栈的-SPA-单页面应用项目，共-15-个具有交互功能的页面。"><a href="#电商后台管理系统是基于Vue-技术栈的-SPA-单页面应用项目，共-15-个具有交互功能的页面。" class="headerlink" title="电商后台管理系统是基于Vue 技术栈的 SPA 单页面应用项目，共 15 个具有交互功能的页面。"></a>电商后台管理系统是基于Vue 技术栈的 SPA 单页面应用项目，共 15 个具有交互功能的页面。</h4><p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120473.jpg" alt="img"></p>
<h4 id="主要技术栈"><a href="#主要技术栈" class="headerlink" title="主要技术栈"></a>主要技术栈</h4><p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120474.png" alt="image-20210704200044327"></p>
<h4 id="登陆功能"><a href="#登陆功能" class="headerlink" title="登陆功能"></a>登陆功能</h4><p>登录业务流程</p>
<ul>
<li><p>在登录页面输入用户名和密码 </p>
</li>
<li><p>调用后台接口进行验证 </p>
</li>
<li><p>通过验证之后，根据后台的响应状态(200)跳转到项目主页</p>
</li>
</ul>
<h4 id="商品管理功能"><a href="#商品管理功能" class="headerlink" title="商品管理功能"></a>商品管理功能</h4><p>在 VueRouter 路由器文件中进行 路由与组件的对应配置。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120475.png" alt="image-20210704200246538"></p>
<p>通过VueRouter路由监听器监听页面中路由的改变，当路由(通过点击文字链接)发生改变，则地址栏中URL发生相应变化，并切换不同的组件展示在页面中。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120476.jpg" alt="img"> </p>
<h4 id="会员管理功能"><a href="#会员管理功能" class="headerlink" title="会员管理功能"></a>会员管理功能</h4><p>(1)统计商城所有会员的来源地以及数量，方便商城进行会员的新增计划。</p>
<p>(2)使用 elementUI 组件库编写页面组件，并具有编辑会员信息和分页功能。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120477.jpg" alt="img"> </p>
<h4 id="销售管理功能"><a href="#销售管理功能" class="headerlink" title="销售管理功能"></a>销售管理功能</h4><p>(1)通过接收后台传来的数据统计商城某段时间的订单来源、订单金额、订单物流状态、商城促销活动的启动与结束。</p>
<p>(2)引入了第三方专业绘图库 Echarts，它是基于 javascript 的实现的开源可视化库。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120478.png" alt="image-20210704200350674"></p>
<h4 id="权限管理功能"><a href="#权限管理功能" class="headerlink" title="权限管理功能"></a>权限管理功能</h4><p>(1)通过权限管理模块控制不同的用户可以进行哪些操作，具体可以通过角色的方式进行控制，即每个用户分配 一个特定的角色，角色包括不同的功能权限。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120479.jpg" alt="img"> </p>
<p>(2)使用组件库进行开发，并有编辑、删除、分页等功能。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120480.jpg" alt="img"> </p>
<h2 id="后台服务详细设计"><a href="#后台服务详细设计" class="headerlink" title="后台服务详细设计"></a>后台服务详细设计</h2><h3 id="接入层"><a href="#接入层" class="headerlink" title="接入层"></a>接入层</h3><p>接入层使用nginx做反向代理</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120481.png" alt="image-20210703145712990"></p>
<p>目前是一个微服务，如果访问量过大，服务器扛不住可以做集群：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120482.png" alt="image-20210703150649717"></p>
<h3 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h3><p>注册中心采用Eureka，Eureka满足CAP定理里的CA，Zookeeper满足CP，相比于Zookeeper，Eureka更在意服务的可用性，对于商城项目，我们也很在意服务的可用性，而对集群之间的一致性要求不是很苛刻，即使某个服务已经宕机，而Eureka没有及时更新也不影响，其他服务访问不到做服务降级，然后再请求另一台服务即可。因此，本项目注册中心选择Eureka。</p>
<h3 id="网关层"><a href="#网关层" class="headerlink" title="网关层"></a>网关层</h3><p>网关层使用Spring Cloud gateway，该层需要配合注册中心进行服务拉取，该层使用ribbon做负载均衡，使用hystrix做服务降级，以及需要实现请求限流，权限控制，解决CROS跨域问题。</p>
<p>请求限流的设计方案一流程图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120483.png" alt="image-20210703125828774"></p>
<p>请求限流的设计方案二流程图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120484.png" alt="image-20210703125935895"></p>
<h3 id="服务层"><a href="#服务层" class="headerlink" title="服务层"></a>服务层</h3><h4 id="用户微服务（ly-user-service）"><a href="#用户微服务（ly-user-service）" class="headerlink" title="用户微服务（ly-user-service）"></a>用户微服务（ly-user-service）</h4><p>地址管理</p>
<p>用户管理</p>
<h4 id="商品微服务-ly-item-service"><a href="#商品微服务-ly-item-service" class="headerlink" title="商品微服务(ly-item-service)"></a>商品微服务(ly-item-service)</h4><p>品牌管理</p>
<p>分类管理</p>
<p>商品管理</p>
<p>规格管理</p>
<h4 id="商品详情页微服务-ly-page"><a href="#商品详情页微服务-ly-page" class="headerlink" title="商品详情页微服务(ly-page)"></a>商品详情页微服务(ly-page)</h4><p>用户搜索到商品后，就会点击商品，查看商品详情内容，就会访问到商品详情页。商品详情页是展示商品详细信息的一个页面，承载在网站的大部分流量和订单的入口。</p>
<p>因此，商品详情页必须能够应对高并发的压力。</p>
<h5 id="设计思路一：传统方案"><a href="#设计思路一：传统方案" class="headerlink" title="设计思路一：传统方案"></a>设计思路一：传统方案</h5><p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120485.png" alt="image-20210704021148458"></p>
<p>基本流程如下：</p>
<ul>
<li>用户请求nginx服务，获取到静态页面</li>
<li>然后页面发起Nginx，向Tomcat服务获取数据</li>
<li>Tomcat查询数据库</li>
<li>页面渲染</li>
</ul>
<p>这种方案下，数据库成了瓶颈，高并发情况下，数据难以支撑。</p>
<h5 id="设计思路二：加入缓存"><a href="#设计思路二：加入缓存" class="headerlink" title="设计思路二：加入缓存"></a>设计思路二：加入缓存</h5><p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120486.png" alt="image-20210704021449739"></p>
<p>这种方案下，整个服务的并发能力，就受限于Tomcat，业务经常受到依赖的服务不稳定而导致的性能抖动。</p>
<h5 id="设计思路三：页面静态化"><a href="#设计思路三：页面静态化" class="headerlink" title="设计思路三：页面静态化"></a>设计思路三：页面静态化</h5><p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120487.png" alt="image-20210704021647900"></p>
<p>基本流程：</p>
<ul>
<li>商品修改发送消息到MQ</li>
<li>微服务监听MQ，得知商品变化，渲染并生成一个静态页面</li>
<li>用户请求Nginx</li>
<li>Nginx直接返回渲染好的静态Html</li>
</ul>
<p>优点：</p>
<ul>
<li>用户请求渲染好的Html，响应速度快</li>
<li>通过MQ异步更新，保证数据同步</li>
</ul>
<p>缺点：</p>
<ul>
<li>小部分数据如价格变更，整个静态页都要重新生成</li>
<li>随着商品数量增加，页面会越来越多</li>
<li>页面模板变更，所有商品的静态页都要重新生成，非常困难</li>
</ul>
<h5 id="设计方案四：动态模版，静态化数据"><a href="#设计方案四：动态模版，静态化数据" class="headerlink" title="设计方案四：动态模版，静态化数据"></a>设计方案四：动态模版，静态化数据</h5><p>流程图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120488.png" alt="image-20210704022129626"></p>
<p>首先，把页面分成几部分：如顶部面包屑、商品SKU展示、商品描述、商品评论等，形成多个页面模板（模块）。对应的数据也分成几部分，这些数据可能来自不同的微服务。这样可以减少因局部变更引起的整个页面重新生成。</p>
<p>将页面模板存储到Nginx中，当用户请求某个页面时，我们在Nginx中渲染模板，把渲染好的模板组合在一起，形成完整页面，返回到用户。</p>
<p>Nginx渲染页面时，需要的数据可以缓存在Nginx的本地共享词典中（长期不会修改的数据），如果命中则直接渲染并返回。如果未命中，则查询Redis集群，获取数据。如果Redis集群依然未命中，再去查询后台微服务，由微服务获取数据，然后写入缓存中，保证下次Nginx可以从缓存中拿到数据。这样可以减少服务端压力。</p>
<p>另外，为了保证Redis数据与数据库数据一致，这里使用Canal技术，监听数据库变化，及时更新Redis数据。</p>
<h4 id="搜索微服务-ly-search"><a href="#搜索微服务-ly-search" class="headerlink" title="搜索微服务(ly-search)"></a>搜索微服务(ly-search)</h4><p>提供搜索服务，搜索框补齐，得解决数据同步问题，搜索功能依赖的商品数据是存储在ElasticSearch中的，但是数据库中也有一份商品数据。当我们对商品做增、删、改这样的操作时，ElasticSearch并未感知到，此时就会出现<strong>数据库数据与索引库数据的不一致</strong>。</p>
<p>不过，我们并不需要在商品增、删、改的时候都对索引库做处理，因为索引库中只需要上架的商品，如果一个商品新增了，并不代表也上架了。而且，商品要修改和删除前必须先下架，商品新增后还要上架。</p>
<p>所以，我们需要做的是：</p>
<ul>
<li>商品上架：在索引库新增数据</li>
<li>商品下架：把数据从索引库删除</li>
</ul>
<p>但商品的上架和下架时商品微服务<code>ly-item</code>中处理的，索引库数据是在<code>ly-search</code>中处理的。我们如何在上架时修改索引库呢？</p>
<p>主要有两种设计方案：</p>
<ul>
<li><p>方案1：在商品微服务的上下架业务后，加入修改索引库数据</p>
</li>
<li><p>方案2：搜索服务对外提供操作索引库，商品微服务在商品上下架后，调用接口。</p>
</li>
</ul>
<p>但是以上两种方式都有同一个严重问题：就是代码耦合，后台服务中需要嵌入搜索和商品页面服务，违背了微服务的独立原则，而且严重违背了开闭原则。</p>
<p>所以在这个地方我们采用消息队列来解决这个问题。</p>
<p>流程图如下：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120489.png" alt="image-20210704015047660"></p>
<p>商品微服务在完成上架、下架后，发送消息到MQ，通知是哪个商品更新了，自己的业务就结束了，商品微服务不需要知道，也不关心到底是谁在监听这条消息。</p>
<p>搜索微服务在接收到消息后，更新索引库数据即可，同样不需要关心别人。</p>
<p>两个微服务之间没有直接调用，没有业务的耦合。</p>
<h4 id="交易微服务-ly-trade"><a href="#交易微服务-ly-trade" class="headerlink" title="交易微服务(ly-trade)"></a>交易微服务(ly-trade)</h4><p>完成存入购物车以及下单功能，只要难点在于分布式事务，分布式锁，以及如何获取登陆用户信息，如何将用户信息与当前请求线程绑定；</p>
<h5 id="获取用户思路分析"><a href="#获取用户思路分析" class="headerlink" title="获取用户思路分析"></a>获取用户思路分析</h5><p>在请求进入交易服务时就获取用户信息，并且将当前用户信息与当前请求线程绑定。</p>
<h6 id="设计方案一：页面直接把用户作为请求参数传递"><a href="#设计方案一：页面直接把用户作为请求参数传递" class="headerlink" title="设计方案一：页面直接把用户作为请求参数传递"></a>设计方案一：页面直接把用户作为请求参数传递</h6><ul>
<li>优点：简单、方便、代码量为0</li>
<li>缺点：不安全，因为调用购物车CRUD的请求时从页面发过来的，不能确定这个传递的参数id是不是用户真实的id。</li>
</ul>
<h6 id="设计方案二：自己从cookie的token中解析用户信息"><a href="#设计方案二：自己从cookie的token中解析用户信息" class="headerlink" title="设计方案二：自己从cookie的token中解析用户信息"></a>设计方案二：自己从cookie的token中解析用户信息</h6><ul>
<li>优点：安全</li>
<li>缺点：需要重复检验jwt，网关层已经做过了；代码还很麻烦</li>
</ul>
<p>当获取用户信息后，我们需要把用户保存起来，方便后面的业务使用。</p>
<p>每次请求都有不同的用户信息，在并发请求情况下，必须保证每次请求保存的用户信息互不干扰，线程独立。可以使用ThreadLocal把<strong>用户与每一个请求线程绑定</strong>。</p>
<h4 id="订单数据结构设计"><a href="#订单数据结构设计" class="headerlink" title="订单数据结构设计"></a>订单数据结构设计</h4><p>采用数据库垂直拆分方式：</p>
<p>订单表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_order` (</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">  `total_fee` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总金额，单位为分&#x27;</span>,</span><br><span class="line">  `actual_fee` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;实付金额。单位:分。如:20007，表示:200元7分&#x27;</span>,</span><br><span class="line">  `payment_type` tinyint(<span class="number">2</span>) unsigned zerofill <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付类型，1、微信支付，2、支付宝支付&#x27;</span>,</span><br><span class="line">  `post_fee` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮费。单位:分。如:20007，表示:200元7分&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单的状态，1、未付款 2、已付款,未发货 3、已发货,未确认 4、确认收货，交易成功 5、交易取消，订单关闭 6、交易结束，已评价&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `pay_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付时间&#x27;</span>,</span><br><span class="line">  `consign_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;发货时间&#x27;</span>,</span><br><span class="line">  `end_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易完成时间&#x27;</span>,</span><br><span class="line">  `close_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易关闭时间&#x27;</span>,</span><br><span class="line">  `comment_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;评价时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`order_id`),</span><br><span class="line">  KEY `multi_key_status_time` (`status`,`create_time`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin;</span><br></pre></td></tr></table></figure>



<p>物流信息表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `tb_order_logistics` (</span><br><span class="line">  `order_id` bigint(20) NOT NULL COMMENT &#x27;订单id，与订单表一对一&#x27;,</span><br><span class="line">  `logistics_number` varchar(18) DEFAULT &#x27;&#x27; COMMENT &#x27;物流单号&#x27;,</span><br><span class="line">  `logistics_company` varchar(18) DEFAULT &#x27;&#x27; COMMENT &#x27;物流公司名称&#x27;,</span><br><span class="line">  `addressee` varchar(32) NOT NULL COMMENT &#x27;收件人&#x27;,</span><br><span class="line">  `phone` varchar(11) NOT NULL COMMENT &#x27;收件人手机号码&#x27;,</span><br><span class="line">  `province` varchar(16) NOT NULL COMMENT &#x27;省&#x27;,</span><br><span class="line">  `city` varchar(32) NOT NULL COMMENT &#x27;市&#x27;,</span><br><span class="line">  `district` varchar(32) NOT NULL COMMENT &#x27;区&#x27;,</span><br><span class="line">  `street` varchar(256) NOT NULL COMMENT &#x27;街道&#x27;,</span><br><span class="line">  `postcode` int(6) DEFAULT &#x27;0&#x27; COMMENT &#x27;邮编&#x27;,</span><br><span class="line">  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`order_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>



<p>订单条目：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_order_detail` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">  `sku_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;sku商品id&#x27;</span>,</span><br><span class="line">  `num` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;购买数量&#x27;</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品标题&#x27;</span>,</span><br><span class="line">  `spec` <span class="type">varchar</span>(<span class="number">1024</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;商品动态属性键值集&#x27;</span>,</span><br><span class="line">  `price` <span class="type">int</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;价格,单位：分&#x27;</span>,</span><br><span class="line">  `image` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;商品图片&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  KEY `key_order_id` (`order_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;订单详情表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h4><h5 id="跨数据源"><a href="#跨数据源" class="headerlink" title="跨数据源"></a>跨数据源</h5><p>随着业务数据规模的快速发展，数据量越来越大，单库单表逐渐成为瓶颈。所以我们对数据库进行了水平拆分，将原单库单表拆分成数据库分片，于是就产生了跨数据库事务问题。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120490.png" alt="image-20210704030852255"></p>
<h5 id="跨服务"><a href="#跨服务" class="headerlink" title="跨服务"></a>跨服务</h5><p>在业务发展初期，“一块大饼”的单业务系统架构，能满足基本的业务需求。但是随着业务的快速发展，系统的访问量和业务复杂程度都在快速增长，单系统架构逐渐成为业务发展瓶颈，解决业务系统的高耦合、可伸缩问题的需求越来越强烈。</p>
<p>如下图所示，按照面向服务（SOA）的架构的设计原则，将单业务系统拆分成多个业务系统，降低了各系统之间的耦合度，使不同的业务系统专注于自身业务，更有利于业务的发展和系统容量的伸缩。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120491.png" alt="image-20210704030946480"></p>
<h5 id="分布式系统数据一致性问题"><a href="#分布式系统数据一致性问题" class="headerlink" title="分布式系统数据一致性问题"></a>分布式系统数据一致性问题</h5><p>在数据库水平拆分、服务垂直拆分之后，一个业务操作通常要跨多个数据库、服务才能完成。在分布式网络环境下，我们无法保障所有服务、数据库都百分百可用，一定会出现部分服务、数据库执行成功，另一部分执行失败的问题。</p>
<p>当出现部分业务操作成功、部分业务操作失败时，业务数据就会出现不一致。</p>
<p>下单付款：</p>
<ul>
<li>创建新订单</li>
<li>扣减商品库存</li>
<li>从用户账户余额扣除金额</li>
</ul>
<p>完成上面的操作需要访问三个不同的微服务和三个不同的数据库。</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120492.png" alt="image-20210704031058760"></p>
<h5 id="设计方案一：TCC"><a href="#设计方案一：TCC" class="headerlink" title="设计方案一：TCC"></a>设计方案一：TCC</h5><p>执行分两个阶段：</p>
<ul>
<li>准备阶段（try）：资源的检测和预留；</li>
<li>执行阶段（confirm&#x2F;cancel）：根据上一步结果，判断下面的执行方法。如果上一步中所有事务参与者都成功，则这里执行confirm。反之，执行cancel</li>
</ul>
<p>流程图如下：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120493.png" alt="image-20210704031150404"></p>
<ul>
<li><p>优势</p>
<p>TCC执行的每一个阶段都会提交本地事务并释放锁，并不需要等待其它事务的执行结果。而如果其它事务执行失败，最后不是回滚，而是执行补偿操作。这样就避免了资源的长期锁定和阻塞等待，执行效率比较高，属于性能最好的分布式事务方式。</p>
</li>
<li><p>缺点</p>
<ul>
<li>代码侵入：需要人为编写代码实现，代码侵入较多</li>
<li>开发成本高：一个业务需要拆分成3个步骤，分别编写业务实现，业务编写比较复杂</li>
<li>安全性考虑：cancel动作如果执行失败，资源就无法释放，需要引入重试机制，而重试可能导致重复执行，还要考虑重试时的幂等问题</li>
</ul>
</li>
</ul>
<h6 id="设计方案二：消息服务"><a href="#设计方案二：消息服务" class="headerlink" title="设计方案二：消息服务"></a>设计方案二：消息服务</h6><p>一般分为事务的发起者A和事务的其它参与者B：</p>
<ul>
<li>事务发起者A执行本地事务</li>
<li>事务发起者A通过MQ将需要执行的事务信息发送给事务参与者B</li>
<li>事务参与者B接收到消息后执行本地事务</li>
</ul>
<p>流程图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120494.png" alt="image-20210704031324120"></p>
<h6 id="设计方案三：独立消息服务"><a href="#设计方案三：独立消息服务" class="headerlink" title="设计方案三：独立消息服务"></a>设计方案三：独立消息服务</h6><p>流程图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120495.png" alt="image-20210704031432367"></p>
<p>时序图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120496.png" alt="image-20210704031531841"></p>
<p>事务发起者A的基本执行步骤：</p>
<ul>
<li>开启本地事务</li>
<li>通知消息服务，准备发送消息（消息服务将消息持久化，标记为准备发送）</li>
<li>执行本地业务，<ul>
<li>执行失败则终止，通知消息服务，取消发送（消息服务修改订单状态）</li>
<li>执行成功则继续，通知消息服务，确认发送（消息服务发送消息、修改订单状态）</li>
</ul>
</li>
<li>提交本地事务</li>
</ul>
<p>消息服务本身提供下面的接口：</p>
<ul>
<li>准备发送：把消息持久化到数据库，并标记状态为准备发送</li>
<li>取消发送：把数据库消息状态修改为取消</li>
<li>确认发送：把数据库消息状态修改为确认发送。尝试发送消息，成功后修改状态为已发送</li>
<li>确认消费：消费者已经接收并处理消息，把数据库消息状态修改为已消费</li>
<li>定时任务：定时扫描数据库中状态为确认发送的消息，然后询问对应的事务发起者，事务业务执行是否成功，结果：<ul>
<li>业务执行成功：尝试发送消息，成功后修改状态为已发送</li>
<li>业务执行失败：把数据库消息状态修改为取消</li>
</ul>
</li>
</ul>
<p>事务参与者B的基本步骤：</p>
<ul>
<li>接收消息</li>
<li>开启本地事务</li>
<li>执行业务</li>
<li>通知消息服务，消息已经接收和处理</li>
<li>提交事务</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>解除了事务业务与消息相关业务的耦合</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>实现起来比较复杂</li>
</ul>
<h6 id="设计方案三：Seata"><a href="#设计方案三：Seata" class="headerlink" title="设计方案三：Seata"></a>设计方案三：Seata</h6><p>一个用户购买商品的业务逻辑。整个业务逻辑由3个微服务提供支持：</p>
<ul>
<li>仓储服务：对给定的商品扣除仓储数量。</li>
<li>订单服务：根据采购需求创建订单。</li>
<li>帐户服务：从用户帐户中扣除余额。</li>
</ul>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120497.png" alt="image-20210704031726133"></p>
<h5 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a>微信支付</h5><ul>
<li>商户生成订单</li>
<li>商户调用微信下单接口，获取预交易的链接</li>
<li>商户将链接生成二维码图片，展示给用户；</li>
<li>支付结果通知：<ul>
<li>微信异步通知商户支付结果，商户告知微信支付接收情况</li>
<li>商户如果没有收到通知，可以调用接口，查询支付状态</li>
</ul>
</li>
<li>如果支付成功，发货，修改订单状态</li>
</ul>
<p>流程图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120498.png" alt="image-20210704032529120"></p>
<h5 id="订单清理"><a href="#订单清理" class="headerlink" title="订单清理"></a>订单清理</h5><p>使用死信交换机（Dead Letter Exchange）来清理。</p>
<p>死信交换机流程图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120499.png" alt="image-20210704033149542">、</p>
<p>在声明的时候，通过<code>x-dead-letter-exchange</code>属性指定一个交换机，被指定的交换机就是<strong>死信交换机（Dead Letter Exchange）</strong>。同时队列还可以指定一个<code>x-dead-letter-routing-key</code>（死信路由）作为死信的<code>routing_key</code>，死信交换机转发消息时会根据这个<code>routing_key</code>来转发消息。</p>
<p>死信交换机接收到消息以后，会根据消息的<code>routing_key</code>再次转发消息到绑定的队列，如果队列绑定到死信交换机时，会根据队列指定的<code>x-dead-letter-routing-key</code>来转发，如果队列没有绑定，则会根据消息来源时指定的<code>routing_key</code>来转发。</p>
<p>例如：现在publisher发送消息时指定<code>routing_key</code>为<code>foo</code>，队列绑定死信交换机时指定了<strong>死信路由</strong>为：<code>bar</code>，则死信交换机转发时，会使用<code>bar</code>作为<code>routing_key</code>，如图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120500.png" alt="image-20210704033509109"></p>
<h3 id="基础服务"><a href="#基础服务" class="headerlink" title="基础服务"></a>基础服务</h3><h4 id="短信微服务"><a href="#短信微服务" class="headerlink" title="短信微服务"></a>短信微服务</h4><p>负责从RabbitMQ中取发短信任务，然后执行发短信服务。</p>
<h4 id="权限微服务"><a href="#权限微服务" class="headerlink" title="权限微服务"></a>权限微服务</h4><p>负责权限认证，授权等</p>
<h4 id="日志服务"><a href="#日志服务" class="headerlink" title="日志服务"></a>日志服务</h4><p>在微服务架构下，微服务被拆分成多个微小的服务，每个微小的服务都部署在不同的服务器实例上，当我们定位问题，检索日志的时候需要依次登录每台服务器进行检索。这样是不是感觉很繁琐和效率低下。所以我们还需要一个工具来帮助集中收集、存储和搜索这些跟踪信息。集中化管理日志后，日志的统计和检索又成为一件比较麻烦的事情。以前，我们通过使用grep、awk和wc等Linux命令能实现检索和统计，但是对于要求更高的查询、排序和统计等要求和庞大的机器数量依然使用这样的方法难免有点力不从心。</p>
<p>分布式日志服务选择graylog4.1，相比于ELK的解决方案，graylog有自己的优势。</p>
<p>ELK解决方案的问题：</p>
<ol>
<li>不能处理多行日志，比如Mysql慢查询，Tomcat&#x2F;Jetty应用的Java异常打印</li>
<li>不能保留原始日志，只能把原始日志分字段保存，这样搜索日志结果是一堆Json格式文本，无法阅读。</li>
<li>不符合正则表达式匹配的日志行，被全部丢弃。</li>
</ol>
<p>GrayLog方案的优势：</p>
<ol>
<li>一体化方案，安装方便，不像ELK有3个独立系统间的集成问题。</li>
<li>采集原始日志，并可以事后再添加字段，比如http_status_code，response_time等等。</li>
<li>自己开发采集日志的脚本，并用curl&#x2F;nc发送到Graylog Server，发送格式是自定义的GELF，Flunted和Logstash都有相应的输出GELF消息的插件。自己开发带来很大的自由度。实际上只需要用inotifywait监控日志的modify事件，并把日志的新增行用curl&#x2F;netcat发送到Graylog Server就可。</li>
<li>搜索结果高亮显示，就像google一样。</li>
<li>搜索语法简单，比如： source:mongo AND reponse_time_ms:&gt;5000，避免直接输入elasticsearch搜索json语法</li>
<li>搜索条件可以导出为elasticsearch的搜索json文本，方便直接开发调用elasticsearch rest api的搜索脚本。</li>
</ol>
<h4 id="阿里云OSS服务"><a href="#阿里云OSS服务" class="headerlink" title="阿里云OSS服务"></a>阿里云OSS服务</h4><p>上传图片至oss可选的设计方案有三种，如下：</p>
<p>传统方式：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120501.png" alt="image-20210703151536054"></p>
<p>web前端签名直传：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120502.png" alt="image-20210703151623594"></p>
<p>服务端签名后直传流程图：</p>
<ul>
<li>用户发送上传请求到应用服务器</li>
<li>应用服务器返回上传policy和签名给用户</li>
<li>用户直接上传数据到OSS</li>
</ul>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120503.png" alt="image-20210703151703004"></p>
<h3 id="数据层"><a href="#数据层" class="headerlink" title="数据层"></a>数据层</h3><h4 id="MySQL-1"><a href="#MySQL-1" class="headerlink" title="MySQL"></a>MySQL</h4><p>可设计</p>
<p>tb_brand:品牌表</p>
<p>tb_category:分类表</p>
<p>tb_category_brand：品牌和分类中间表</p>
<p>tb_coupon：优惠卷</p>
<p>tb_order：订单表</p>
<p>tb_order_detail：订单细节表</p>
<p>tb_order_logistics：订单发货地址表</p>
<p>tb_pay_log：支付详情表</p>
<p>tb_promition_condition：优惠条件表</p>
<p>tb_promition：秒杀表</p>
<p>tb_sku：商品sku表</p>
<p>tb_spec_group：商品规格组表</p>
<p>tb_spec_param：商品参数表</p>
<p>tb_spu：Spu表</p>
<p>tb_spu_detail：spu详情表</p>
<p>tb_user：用户表</p>
<p>tb_user_coupon：用户优惠卷表</p>
<p>undo_log：seata的undo log表</p>
<h4 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h4><p>用于做搜索推荐</p>
<h4 id="Redis-1"><a href="#Redis-1" class="headerlink" title="Redis"></a>Redis</h4><p>存储短信验证码，用户token，商品SPU，SKU信息</p>
<h4 id="MongoDB-1"><a href="#MongoDB-1" class="headerlink" title="MongoDB"></a>MongoDB</h4><p>对于购物车数据，不是很重要并且数量很多，使用MySQL存储成本比较高，可以使用更廉价的MongoDB来存储。</p>
<h1 id="五、项目主要模块实现"><a href="#五、项目主要模块实现" class="headerlink" title="五、项目主要模块实现"></a>五、项目主要模块实现</h1><h2 id="项目准备工作"><a href="#项目准备工作" class="headerlink" title="项目准备工作"></a>项目准备工作</h2><h3 id="技术选择"><a href="#技术选择" class="headerlink" title="技术选择"></a>技术选择</h3><p>前端技术包括：</p>
<ul>
<li>基础的HTML、CSS、JavaScript（基于ES6标准）</li>
<li>JQuery</li>
<li>Vue.js 2.0</li>
<li>基于Vue的UI框架：Vuetify、类似于BootStrap、element-ui</li>
<li>前端构建工具：WebPack，项目编译、打包工具</li>
<li>前端安装包工具：NPM</li>
<li>Vue脚手架：Vue-cli</li>
<li>Vue路由：vue-router</li>
<li>ajax框架：axios</li>
<li>基于Vue的富文本框架：quill-editor</li>
</ul>
<p>服务端技术包括：</p>
<ul>
<li>基础的SpringMVC、Spring和MyBatis（MybatisPlus）</li>
<li>Spring Boot 2</li>
<li>Spring Cloud 技术栈</li>
<li>OpenResty（Nginx + Lua）</li>
<li>Redis、Jedis、Lua脚本</li>
<li>RabbitMQ</li>
<li>Elasticsearch</li>
<li>Nginx</li>
<li>MongoDB</li>
<li>Canal</li>
<li>JWT</li>
<li>GrayLog日志系统</li>
<li>Skywalking链路追踪</li>
<li>Seata分布式事务</li>
<li>阿里OSS、CMS等服务</li>
<li>微信支付</li>
</ul>
<h3 id="项目开发环境"><a href="#项目开发环境" class="headerlink" title="项目开发环境"></a>项目开发环境</h3><ul>
<li>IDE：使用IDEA 2020.3和WebStorm 2020.3</li>
<li>JDK：统一使用JDK1.8</li>
<li>项目构建：maven 3.2.x</li>
</ul>
<h3 id="项目测试环境"><a href="#项目测试环境" class="headerlink" title="项目测试环境"></a>项目测试环境</h3><ul>
<li><p>Windows 10 16G</p>
<p>运行Nignx 1.12、管理员页面，门户页面，10个微服务（jar包形式）</p>
</li>
<li><p>Mac：Centos 7.5 6G 本地虚拟机</p>
<p>已docker容器方式运行，mysql:5.7.25，elasticsearch 7.2，redis，mongo，mongo-express，canal&#x2F;canal-server，rabbitmq:3-management，kibana:7.4.2 ，</p>
</li>
<li><p>阿里云服务器ECS </p>
<p>已docker方式运行，mongo4.2，es7.10，graylog4</p>
</li>
<li><p>腾讯云服务器ECS </p>
<p>已docker方式运行mysql：5.7.25，redis，canal&#x2F;canal-server，mongo，mongo-express，运行skywalking 8，其中需要使用阿里云安装的es7.10</p>
</li>
<li><p>阿里云SMS服务</p>
</li>
<li><p>阿里云OSS存储服务</p>
</li>
</ul>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p>项目有许多微服务组成，而每个微服务的依赖及版本信息需要统一管理，因此需要有一个父工程。</p>
<p>而每个微服务本身有自己的业务，并且服务和服务间会有相互调用，需要将自身的实体类、Feign接口对外暴露出去，提供成jar包供别人加载，项目结构如图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120505.png" alt="截屏2021-07-03 下午5.10.56"></p>
<h2 id="ElasticSearch数据同步问题解决方案"><a href="#ElasticSearch数据同步问题解决方案" class="headerlink" title="ElasticSearch数据同步问题解决方案"></a>ElasticSearch数据同步问题解决方案</h2><p>搜索功能依赖的商品数据是存储在ElasticSearch中的，但是数据库中也有一份商品数据。当我们对商品做增、删、改这样的操作时，ElasticSearch并未感知到，此时就会出现<strong>数据库数据与索引库数据的不一致</strong>。</p>
<p>在项目设计时使用消息队列来解决这个问题，但是具体实现还需考虑一下几个问题：</p>
<ul>
<li><p>什么时候发消息？</p>
<ul>
<li>当商品服务对商品进行上下架的时候，需要发送一条消息，通知其它服务</li>
</ul>
</li>
<li><p>商品微服务发送消息的内容是什么？</p>
<ul>
<li>对商品的增删改时其它服务可能需要新的商品数据，但是如果消息内容中包含全部商品信息，数据量太大，而且并不是每个服务都需要全部的信息。因此我们<strong>只发送商品id</strong>，其它服务可以根据id查询自己需要的信息。</li>
</ul>
</li>
<li><p>搜索微服务接收消息后如何处理？</p>
<ul>
<li>上架：添加新的数据到索引库</li>
<li>下架：删除索引库数据</li>
</ul>
</li>
</ul>
<p>编写消息队列常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.common.constants;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseMQConstants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ExchangeConstants</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 商品服务交换机名称</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ITEM_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ly.item.exchange&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息服务交换机名称</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SMS_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ly.sms.exchange&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 订单业务的交换机</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ORDER_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ly.order.exchange&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 死信队列交换机名称</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ly.dead.exchange&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RoutingKeyConstants</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 商品上架的routing-key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ITEM_UP_KEY</span> <span class="operator">=</span> <span class="string">&quot;item.up&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 商品下架的routing-key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ITEM_DOWN_KEY</span> <span class="operator">=</span> <span class="string">&quot;item.down&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 短信验证的routing-key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VERIFY_CODE_KEY</span> <span class="operator">=</span> <span class="string">&quot;sms.verify.code&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 清理订单routing-key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EVICT_ORDER_KEY</span> <span class="operator">=</span> <span class="string">&quot;order.evict&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">QueueConstants</span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 搜索服务，商品上架的队列</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SEARCH_ITEM_UP</span> <span class="operator">=</span> <span class="string">&quot;search.item.up.queue&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 搜索服务，商品下架的队列</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SEARCH_ITEM_DOWN</span> <span class="operator">=</span> <span class="string">&quot;search.item.down.queue&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 搜索服务，商品下架的队列</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SMS_VERIFY_CODE_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;sms.verify.code.queue&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 订单死信队列名称</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_ORDER_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;ly.dead.order.queue&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 订单清理队列名称</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EVICT_ORDER_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;ly.evict.order.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="商品微服务发送消息"><a href="#商品微服务发送消息" class="headerlink" title="商品微服务发送消息"></a>商品微服务发送消息</h3><p>Json消息转化器：</p>
<p>默认情况下，AMQP会使用JDK的序列化方式对发送的消息进行处理，传输数据比较大，效率太低，可读性差。这里自定义消息转换器，使用JSON来处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.item.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-06-04 01:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Jackson2JsonMessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>SpuServiceImpl.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateSaleable</span><span class="params">(Long id, Boolean saleable)</span> &#123;</span><br><span class="line">      <span class="comment">// 1.更新SPU</span></span><br><span class="line">      <span class="type">Spu</span> <span class="variable">spu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Spu</span>();</span><br><span class="line">      spu.setId(id);</span><br><span class="line">      spu.setSaleable(saleable);</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> updateById(spu);</span><br><span class="line">      <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">500</span>, <span class="string">&quot;更新上下架信息失败&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 2.更新SKU</span></span><br><span class="line">      flag = skuService.update().eq(<span class="string">&quot;spu_id&quot;</span>, id).set(<span class="string">&quot;saleable&quot;</span>, saleable).update();</span><br><span class="line">      <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">500</span>, <span class="string">&quot;更新sku上下架信息失败&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 3.发送MQ消息</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> saleable ? BaseMQConstants.RoutingKeyConstants.ITEM_UP_KEY</span><br><span class="line">              : BaseMQConstants.RoutingKeyConstants.ITEM_DOWN_KEY;</span><br><span class="line">      rabbitTemplate.convertAndSend(BaseMQConstants.ExchangeConstants.ITEM_EXCHANGE_NAME, routingKey, id);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="搜索微服务接受消息"><a href="#搜索微服务接受消息" class="headerlink" title="搜索微服务接受消息"></a>搜索微服务接受消息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.search.service.SearchService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ExchangeTypes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.ExchangeConstants.ITEM_EXCHANGE_NAME;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.QueueConstants.SEARCH_ITEM_DOWN;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.QueueConstants.SEARCH_ITEM_UP;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.RoutingKeyConstants.ITEM_DOWN_KEY;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.RoutingKeyConstants.ITEM_UP_KEY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-05-31 11:54 上午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SearchService searchService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ItemListener</span><span class="params">(SearchService searchService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.searchService = searchService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = SEARCH_ITEM_UP, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = ITEM_EXCHANGE_NAME, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">            key = ITEM_UP_KEY</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenItemUp</span><span class="params">(Long spuId)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(spuId != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 新增商品到索引库</span></span><br><span class="line">            searchService.saveGoodsById(spuId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = SEARCH_ITEM_DOWN, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = ITEM_EXCHANGE_NAME, type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">            key = ITEM_DOWN_KEY</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenItemDown</span><span class="params">(Long spuId)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(spuId != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 从索引库删除指定商品</span></span><br><span class="line">            searchService.deleteGoodsById(spuId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="商品静态页实现（处理高并发请求）"><a href="#商品静态页实现（处理高并发请求）" class="headerlink" title="商品静态页实现（处理高并发请求）"></a>商品静态页实现（处理高并发请求）</h2><h3 id="主要代码："><a href="#主要代码：" class="headerlink" title="主要代码："></a>主要代码：</h3><p>GoodsPageServiceImpl.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.BeanHelper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.JsonUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.client.ItemClient;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.dto.*;</span><br><span class="line"><span class="keyword">import</span> com.leyou.page.dto.SpecGroupNameDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.page.dto.SpecParamNameDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.page.service.PageService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-06-01 2:52 下午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">PageService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ItemClient itemClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX_SPU</span> <span class="operator">=</span> <span class="string">&quot;page:spu:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX_SKU</span> <span class="operator">=</span> <span class="string">&quot;page:sku:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX_DETAIL</span> <span class="operator">=</span> <span class="string">&quot;page:detail:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX_CATEGORY</span> <span class="operator">=</span> <span class="string">&quot;page:category:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX_BRAND</span> <span class="operator">=</span> <span class="string">&quot;page:brand:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX_SPEC</span> <span class="operator">=</span> <span class="string">&quot;page:spec:id:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PageServiceImpl</span><span class="params">(ItemClient itemClient, StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.itemClient = itemClient;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loadSpuData</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">        <span class="type">SpuDTO</span> <span class="variable">spu</span> <span class="operator">=</span> itemClient.querySpuById(spuId);</span><br><span class="line">        <span class="comment">// 组织数据</span></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, spu.getId());</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, spu.getName());</span><br><span class="line">        map.put(<span class="string">&quot;categoryIds&quot;</span>, spu.getCategoryIds());</span><br><span class="line">        map.put(<span class="string">&quot;brandId&quot;</span>, spu.getBrandId());</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JsonUtils.toJson(map);</span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_SPU + spuId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loadSpuDetailData</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">        <span class="type">SpuDetailDTO</span> <span class="variable">spuDetailDTO</span> <span class="operator">=</span> itemClient.querySpuDetailById(spuId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JsonUtils.toJson(spuDetailDTO);</span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_DETAIL + spuId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loadSkuListData</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">        <span class="comment">// 查询信息</span></span><br><span class="line">        List&lt;SkuDTO&gt; skuList = itemClient.querySkuBySpuId(spuId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JsonUtils.toJson(skuList);</span><br><span class="line">        <span class="comment">// 存入redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_SKU + spuId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loadCategoriesData</span><span class="params">(List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">        List&lt;CategoryDTO&gt; list = itemClient.queryCategoryByIds(ids);</span><br><span class="line">        List&lt;HashMap&lt;String, Object&gt;&gt; rList = list.stream().map(categoryDTO -&gt; &#123;</span><br><span class="line">            HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;id&quot;</span>, categoryDTO.getId());</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, categoryDTO.getName());</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JsonUtils.toJson(rList);</span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_CATEGORY + ids.get(ids.size() - <span class="number">1</span>), json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loadBrandData</span><span class="params">(Long brandId)</span> &#123;</span><br><span class="line"><span class="comment">// 查询信息</span></span><br><span class="line">        <span class="type">BrandDTO</span> <span class="variable">brand</span> <span class="operator">=</span> itemClient.queryBrandById(brandId);</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, brand.getId());</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, brand.getName());</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JsonUtils.toJson(map);</span><br><span class="line">        <span class="comment">// 存入Redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_BRAND + brandId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loadSpecData</span><span class="params">(Long categoryId)</span> &#123;</span><br><span class="line">        List&lt;SpecGroupDTO&gt; list = itemClient.querySpecGroupDetailByCategoryId(categoryId);</span><br><span class="line">        List&lt;SpecGroupNameDTO&gt; collect = list.stream().map(specGroupDTO -&gt; &#123;</span><br><span class="line">            <span class="type">SpecGroupNameDTO</span> <span class="variable">groupNameDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpecGroupNameDTO</span>();</span><br><span class="line">            groupNameDTO.setName(specGroupDTO.getName());</span><br><span class="line">            groupNameDTO.setParams(BeanHelper.copyWithCollection(specGroupDTO.getParams(), SpecParamNameDTO.class));</span><br><span class="line">            <span class="keyword">return</span> groupNameDTO;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JsonUtils.toJson(collect);</span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_SPEC + categoryId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">deleteSku</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.delete(KEY_PREFIX_SKU + spuId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>item.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入模块</span></span><br><span class="line"><span class="keyword">local</span> common = <span class="built_in">require</span>(<span class="string">&quot;common&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> read_redis = common.read_redis  </span><br><span class="line"><span class="keyword">local</span> read_http = common.read_http</span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span>(<span class="string">&quot;cjson&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)  </span><br><span class="line"><span class="comment">-- 常用变量和方法</span></span><br><span class="line"><span class="keyword">local</span> ngx_log = ngx.<span class="built_in">log</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_ERR = ngx.ERR  </span><br><span class="line"><span class="keyword">local</span> ngx_exit = ngx.<span class="built_in">exit</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_print = ngx.<span class="built_in">print</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_re_match = ngx.re.<span class="built_in">match</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取商品id</span></span><br><span class="line"><span class="keyword">local</span> spuId = ngx.var.spuId</span><br><span class="line"><span class="comment">-- 获取spu</span></span><br><span class="line"><span class="keyword">local</span> spuKey = <span class="string">&quot;page:spu:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> spuInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;spuKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> spuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found spu info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   spuInfoStr = read_http(<span class="string">&quot;/spu/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> spuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found spuInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取sku</span></span><br><span class="line"><span class="keyword">local</span> skuKey = <span class="string">&quot;page:sku:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> skuInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;skuKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> skuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found sku info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   skuInfoStr = read_http(<span class="string">&quot;/sku/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> skuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found skuInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取spuDetail</span></span><br><span class="line"><span class="keyword">local</span> detailKey = <span class="string">&quot;page:detail:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> detailInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;detailKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> detailInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found detail info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   detailInfoStr = read_http(<span class="string">&quot;/detail/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> detailInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found detailInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取categories</span></span><br><span class="line"><span class="keyword">local</span> spuInfo = cjson.decode(spuInfoStr)  </span><br><span class="line"><span class="keyword">local</span> cid3 = spuInfo[<span class="string">&quot;categoryIds&quot;</span>][<span class="number">3</span>]</span><br><span class="line"><span class="keyword">local</span> categoryKey = <span class="string">&quot;page:category:id:&quot;</span>..cid3 </span><br><span class="line"><span class="keyword">local</span> categoryStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;categoryKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> categoryStr <span class="keyword">then</span>  </span><br><span class="line">   <span class="keyword">local</span> idStr = <span class="built_in">table</span>.<span class="built_in">concat</span>(spuInfo[<span class="string">&quot;categoryIds&quot;</span>],<span class="string">&quot;,&quot;</span>);</span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found category info, back to http, categoryIds : &quot;</span>, idStr)  </span><br><span class="line">   categoryStr = read_http(<span class="string">&quot;/categories/&quot;</span>, &#123;ids  = idStr&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> categoryStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found categoryStr info, categoryId : &quot;</span>, cid3)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取品牌  </span></span><br><span class="line"><span class="keyword">local</span> brandId = spuInfo[<span class="string">&quot;brandId&quot;</span>]</span><br><span class="line"><span class="keyword">local</span> brandKey = <span class="string">&quot;page:brand:id:&quot;</span>..brandId </span><br><span class="line"><span class="keyword">local</span> brandStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;brandKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> brandStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found brand info, back to http, brandId : &quot;</span>, brandId)  </span><br><span class="line">   brandStr = read_http(<span class="string">&quot;/brand/&quot;</span>..brandId, &#123;&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> brandStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found brandStr info, brandId : &quot;</span>, brandId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取规格</span></span><br><span class="line"><span class="keyword">local</span> specKey = <span class="string">&quot;page:spec:id:&quot;</span>..cid3 </span><br><span class="line"><span class="keyword">local</span> specStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;specKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> specStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found spec info, back to http, cid3 : &quot;</span>, cid3)  </span><br><span class="line">   specStr = read_http(<span class="string">&quot;/spec/&quot;</span>..cid3, &#123;&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> specStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found specStr info, cid3 : &quot;</span>, cid3)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 组织数据</span></span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">	name = spuInfo[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">	skuList =  skuInfoStr,</span><br><span class="line">	detail =  detailInfoStr,</span><br><span class="line">	categories =  categoryStr,</span><br><span class="line">	brand =  brandStr,</span><br><span class="line">	specs =  specStr</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--渲染模板  </span></span><br><span class="line">template.render(<span class="string">&quot;item.html&quot;</span>, context)</span><br></pre></td></tr></table></figure>

<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><ul>
<li>在Nginx中设置本地缓存，把几乎不变的数据直接存储在nginx内部，例如：<ul>
<li>商品分类数据</li>
<li>品牌数据</li>
<li>规格参数数据</li>
</ul>
</li>
<li>在nginx中对生成的页面做缓存或静态化，做CDN服务，页面不变的时候，减少渲染对CPU的消耗</li>
<li>随着商品数据的日益增多，Redis可能难以支持海量商品信息，此时可以用SSDB来代替，SSDB存储基于磁盘存储，查询性能与Redis差不多，因此可以作为海量数据的缓存库</li>
</ul>
<p>修改nginx.conf,配置本地缓存的大小：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">error_log</span> logs/<span class="literal">error</span>.log;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="attribute">lua_package_path</span> <span class="string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span>;  <span class="comment">#lua 模块  </span></span><br><span class="line">    <span class="attribute">lua_package_cpath</span> <span class="string">&quot;/usr/local/openresty/lualib/?.so;;&quot;</span>;  <span class="comment">#c模块 </span></span><br><span class="line">    <span class="comment">#本地缓存，名称叫做：item_local_cache，大小50m</span></span><br><span class="line">	<span class="attribute">lua_shared_dict</span> item_local_cache <span class="number">50m</span>; </span><br><span class="line">	</span><br><span class="line">    <span class="attribute">default_type</span>  text/html; <span class="comment"># 默认响应类型是html</span></span><br><span class="line">    <span class="comment">#include lua.conf;    # 引入一个lua.conf文件</span></span><br><span class="line">    <span class="attribute">include</span> leyou.conf;    <span class="comment"># 引入一个leyou.conf文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改common.lua，添加数据查询方法：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入redis模块</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>) </span><br><span class="line"><span class="comment">-- 配置商品的本地缓存 </span></span><br><span class="line"><span class="keyword">local</span> local_cache = ngx.shared.item_local_cache</span><br><span class="line"><span class="comment">-- 日志</span></span><br><span class="line"><span class="keyword">local</span> ngx_log = ngx.<span class="built_in">log</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_ERR = ngx.ERR</span><br><span class="line"><span class="comment">-- 读取本地缓存</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_get</span><span class="params">(key)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> local_cache <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">return</span> local_cache:get(key)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 写入本地缓存</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_set</span><span class="params">(key, value)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> local_cache <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">return</span> local_cache:set(key, value, <span class="number">10</span> * <span class="number">60</span>) <span class="comment">--10分钟  </span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">(red)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> red <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="comment">--释放连接(连接池实现)  </span></span><br><span class="line">    <span class="keyword">local</span> pool_max_idle_time = <span class="number">10000</span> <span class="comment">--毫秒  </span></span><br><span class="line">    <span class="keyword">local</span> pool_size = <span class="number">100</span> <span class="comment">--连接池大小  </span></span><br><span class="line">    <span class="keyword">local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;set redis keepalive error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 查询本地缓存，没有则查询redis, ip和port是redis地址，key是查询的key</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_cache</span><span class="params">(ip, port, key)</span></span> </span><br><span class="line">	<span class="comment">-- 尝试读本地缓存</span></span><br><span class="line">	<span class="keyword">local</span> resp = cache_get(key)</span><br><span class="line">	<span class="comment">-- ngx_log(ngx_ERR, &quot;debug local cache data : &quot;, resp) </span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span></span><br><span class="line">		ngx_log(ngx_ERR, <span class="string">&quot;read local cache fail , key&quot;</span>, key)</span><br><span class="line">		<span class="comment">-- 获取一个redis连接</span></span><br><span class="line">		<span class="keyword">local</span> red = redis:new()  </span><br><span class="line">		red:set_timeout(<span class="number">1000</span>)  </span><br><span class="line">		<span class="keyword">local</span> ok, err = red:connect(ip, port)  </span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">			ngx_log(ngx_ERR, <span class="string">&quot;connect to redis error : &quot;</span>, err)  </span><br><span class="line">			<span class="keyword">return</span> close_redis(red)  </span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		<span class="comment">-- 利用get查询</span></span><br><span class="line">		resp, err = red:get(key) </span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment">-- 查询失败处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;get redis content error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">--得到的数据为空处理  </span></span><br><span class="line">    <span class="keyword">if</span> resp == ngx.null <span class="keyword">then</span>  </span><br><span class="line">        resp = <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	cache_set(key, resp)</span><br><span class="line">    close_redis(red)  </span><br><span class="line">    <span class="keyword">return</span> resp  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 查询redis的方法 ip和port是redis地址，keys是查询的key，数组格式</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_redis</span><span class="params">(ip, port, key)</span></span>  </span><br><span class="line">	<span class="comment">-- 获取一个连接</span></span><br><span class="line">    <span class="keyword">local</span> red = redis:new()  </span><br><span class="line">    red:set_timeout(<span class="number">1000</span>)  </span><br><span class="line">    <span class="keyword">local</span> ok, err = red:connect(ip, port)  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;connect to redis error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">local</span> resp = <span class="literal">nil</span></span><br><span class="line">	<span class="comment">-- 利用get查询 </span></span><br><span class="line">    resp, err = red:get(key)  </span><br><span class="line">	<span class="comment">-- 查询失败处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;get redis content error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">--得到的数据为空处理  </span></span><br><span class="line">    <span class="keyword">if</span> resp == ngx.null <span class="keyword">then</span>  </span><br><span class="line">        resp = <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    close_redis(red)  </span><br><span class="line">    <span class="keyword">return</span> resp  </span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"><span class="comment">-- 查询http请求的方法，path是请求路径，args是参数，table格式</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_http</span><span class="params">(path, args)</span></span> </span><br><span class="line">	<span class="comment">-- 默认查询地址走 /backend/page/,内部转发到8083端口</span></span><br><span class="line">    <span class="keyword">local</span> resp = ngx.location.capture(<span class="string">&quot;/backend/page&quot;</span>..<span class="built_in">path</span>, &#123;  </span><br><span class="line">        method = ngx.HTTP_GET,  </span><br><span class="line">        args = args  </span><br><span class="line">    &#125;)  </span><br><span class="line">	<span class="comment">-- 查询失败的处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;request error&quot;</span>)  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	<span class="comment">-- 返回状态码不是200就报错</span></span><br><span class="line">    <span class="keyword">if</span> resp.<span class="built_in">status</span> ~= <span class="number">200</span> <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;request error, status :&quot;</span>, resp.<span class="built_in">status</span>)  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> resp.body  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 将方法导出</span></span><br><span class="line"><span class="keyword">local</span> _M = &#123;  </span><br><span class="line">    read_redis = read_redis,  </span><br><span class="line">    read_cache = read_cache,  </span><br><span class="line">    read_http = read_http  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> _M </span><br></pre></td></tr></table></figure>



<p>改造<code>item.lua</code>，将分类、品牌、规格查询走本地缓存</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入模块</span></span><br><span class="line"><span class="keyword">local</span> common = <span class="built_in">require</span>(<span class="string">&quot;common&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> read_redis = common.read_redis  </span><br><span class="line"><span class="keyword">local</span> read_http = common.read_http</span><br><span class="line"><span class="keyword">local</span> read_cache = common.read_cache</span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span>(<span class="string">&quot;cjson&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)  </span><br><span class="line"><span class="comment">-- 常用变量和方法</span></span><br><span class="line"><span class="keyword">local</span> ngx_log = ngx.<span class="built_in">log</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_ERR = ngx.ERR  </span><br><span class="line"><span class="keyword">local</span> ngx_exit = ngx.<span class="built_in">exit</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_print = ngx.<span class="built_in">print</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_re_match = ngx.re.<span class="built_in">match</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取商品id</span></span><br><span class="line"><span class="keyword">local</span> spuId = ngx.var.spuId</span><br><span class="line"><span class="comment">-- 获取spu</span></span><br><span class="line"><span class="keyword">local</span> spuKey = <span class="string">&quot;page:spu:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> spuInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, spuKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> spuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found spu info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   spuInfoStr = read_http(<span class="string">&quot;/spu/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> spuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found spuInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取sku</span></span><br><span class="line"><span class="keyword">local</span> skuKey = <span class="string">&quot;page:sku:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> skuInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, skuKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> skuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found sku info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   skuInfoStr = read_http(<span class="string">&quot;/sku/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> skuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found skuInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取spuDetail</span></span><br><span class="line"><span class="keyword">local</span> detailKey = <span class="string">&quot;page:detail:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> detailInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, detailKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> detailInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found detail info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   detailInfoStr = read_http(<span class="string">&quot;/detail/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> detailInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found detailInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取categories</span></span><br><span class="line"><span class="keyword">local</span> spuInfo = cjson.decode(spuInfoStr)  </span><br><span class="line"><span class="keyword">local</span> cid3 = spuInfo[<span class="string">&quot;categoryIds&quot;</span>][<span class="number">3</span>]</span><br><span class="line"><span class="keyword">local</span> categoryKey = <span class="string">&quot;page:category:id:&quot;</span>..cid3 </span><br><span class="line"><span class="keyword">local</span> categoryStr = read_cache(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, categoryKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> categoryStr <span class="keyword">then</span>  </span><br><span class="line">   <span class="keyword">local</span> idStr = <span class="built_in">table</span>.<span class="built_in">concat</span>(spuInfo[<span class="string">&quot;categoryIds&quot;</span>],<span class="string">&quot;,&quot;</span>);</span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found category info, back to http, categoryIds : &quot;</span>, idStr)  </span><br><span class="line">   categoryStr = read_http(<span class="string">&quot;/categories/&quot;</span>, &#123;ids  = idStr&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> categoryStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found categoryStr info, categoryId : &quot;</span>, cid3)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取品牌  </span></span><br><span class="line"><span class="keyword">local</span> brandId = spuInfo[<span class="string">&quot;brandId&quot;</span>]</span><br><span class="line"><span class="keyword">local</span> brandKey = <span class="string">&quot;page:brand:id:&quot;</span>..brandId </span><br><span class="line"><span class="keyword">local</span> brandStr = read_cache(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, brandKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> brandStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found brand info, back to http, brandId : &quot;</span>, brandId)  </span><br><span class="line">   brandStr = read_http(<span class="string">&quot;/brand/&quot;</span>..brandId, &#123;&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> brandStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found brandStr info, brandId : &quot;</span>, brandId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取规格</span></span><br><span class="line"><span class="keyword">local</span> specKey = <span class="string">&quot;page:spec:id:&quot;</span>..cid3 </span><br><span class="line"><span class="keyword">local</span> specStr = read_cache(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, specKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> specStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found spec info, back to http, cid3 : &quot;</span>, cid3)  </span><br><span class="line">   specStr = read_http(<span class="string">&quot;/spec/&quot;</span>..cid3, &#123;&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> specStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found specStr info, cid3 : &quot;</span>, cid3)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 组织数据1</span></span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">	name = spuInfo[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">	skuList =  skuInfoStr,</span><br><span class="line">	detail =  detailInfoStr,</span><br><span class="line">	categories =  categoryStr,</span><br><span class="line">	brand =  brandStr,</span><br><span class="line">	specs =  specStr</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--渲染模板  1</span></span><br><span class="line">template.render(<span class="string">&quot;item.html&quot;</span>, context)  </span><br></pre></td></tr></table></figure>

<h3 id="Canal实现缓存数据同步"><a href="#Canal实现缓存数据同步" class="headerlink" title="Canal实现缓存数据同步"></a>Canal实现缓存数据同步</h3><p>MySQL主备复制原理</p>
<ul>
<li>MySQL master 将<strong>数据变更</strong>写入二进制日志( binary log, 其中记录叫做二进制日志事件binary log events，可以通过 show binlog events 进行查看)</li>
<li>MySQL slave 将 master 的 binary log events 拷贝到它的中继日志(relay log)</li>
<li>MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li>
</ul>
<p>canal 工作原理</p>
<ul>
<li>canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump 协议</li>
<li>MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</li>
<li>Canal 解析 binary log 对象(原始为 byte 流)</li>
</ul>
<h4 id="关键代码："><a href="#关键代码：" class="headerlink" title="关键代码："></a>关键代码：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page.canal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.page.service.PageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> top.javatool.canal.client.annotation.CanalTable;</span><br><span class="line"><span class="keyword">import</span> top.javatool.canal.client.context.CanalContext;</span><br><span class="line"><span class="keyword">import</span> top.javatool.canal.client.handler.EntryHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-06-04 2:52 下午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CanalTable(value = &quot;all&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanalHandler</span> <span class="keyword">implements</span> <span class="title class_">EntryHandler</span>&lt;Map&lt;String, String&gt;&gt;&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PageService pageService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CanalHandler</span><span class="params">(PageService pageService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pageService = pageService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Map&lt;String,String&gt; model)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取表的名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">table</span> <span class="operator">=</span> CanalContext.getModel().getTable();</span><br><span class="line">        <span class="comment">// 如果表是tb_sku</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;tb_sku&quot;</span>.equals(table))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;sku新增了&#123;&#125;&quot;</span>, model);</span><br><span class="line">            pageService.loadSkuListData(Long.valueOf(model.get(<span class="string">&quot;spu_id&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Map&lt;String,String&gt; before, Map&lt;String,String&gt; after)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">table</span> <span class="operator">=</span> CanalContext.getModel().getTable();</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;tb_sku&quot;</span>.equals(table))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;sku修改了&#123;&#125;&quot;</span>, after);</span><br><span class="line">            pageService.loadSkuListData(Long.valueOf(after.get(<span class="string">&quot;spu_id&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Map&lt;String,String&gt; model)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">table</span> <span class="operator">=</span> CanalContext.getModel().getTable();</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;tb_sku&quot;</span>.equals(table))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;sku删除了&#123;&#125;&quot;</span>, model);</span><br><span class="line">            pageService.deleteSku(Long.valueOf(model.get(<span class="string">&quot;spu_id&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="JWT登陆实现"><a href="#JWT登陆实现" class="headerlink" title="JWT登陆实现"></a>JWT登陆实现</h2><p>用户授权直接在网关做，如果在每个微服务单独做权限控制，每个微服务上的权限代码就会有重复。</p>
<p>流程图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120506.png" alt="image-20210704023834746"></p>
<p>权限控制流程：</p>
<ul>
<li><p>获取用户的登陆凭证jwt</p>
</li>
<li><p>解析jwt，获取用户身份</p>
<ul>
<li>如果解析失败，证明没有登陆，返回401</li>
</ul>
</li>
<li><p>根据身份，查询用户权限信息</p>
</li>
<li><p>获取当前请求资源（微服务接口路径）</p>
</li>
<li><p>判断是否有访问的资源的权限（通过则放行，不通过则返回401）</p>
</li>
</ul>
<h3 id="Token失效问题具体实现"><a href="#Token失效问题具体实现" class="headerlink" title="Token失效问题具体实现"></a>Token失效问题具体实现</h3><p>JWT的无法修改特性。因此<strong>我们不能修改token来标记token无效，而是在服务端记录token状态</strong>，于是就违背了无状态性的特性。</p>
<p>实现思路如下：</p>
<ul>
<li>用户登陆后，生成JWT，其中包含用户身份、JWT的ID（JTI）</li>
<li>以用户id为key，把JWT的id存入redis，只有redis中有的JWT，才是有效的JWT</li>
<li>并且给Redis中的用户id设置有效期，设置为30分钟，有效期到自动删除，登陆失效</li>
<li>退出登陆的时候，把JTI从Redis删除，把JWT从cookie中删除即可。</li>
</ul>
<p>流程图如下：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120507.png" alt="image-20210704024901219"></p>
<p>具体代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.config.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.service.UserAuthService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.constants.BaseRedisConstants;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.Payload;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.exception.LyException;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.CookieUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.user.client.UserClient;</span><br><span class="line"><span class="keyword">import</span> com.leyou.user.dto.UserDTO;</span><br><span class="line"><span class="keyword">import</span> feign.FeignException;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseTokenConstants.COOKIE_NAME;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseTokenConstants.DOMAIN;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-06-06 9:05 下午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAuthServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserAuthService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserClient userClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtProperties jwtProperties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserAuthServiceImpl</span><span class="params">(UserClient userClient, JwtProperties jwtProperties, StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userClient = userClient;</span><br><span class="line">        <span class="built_in">this</span>.jwtProperties = jwtProperties;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(String username, String password, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(username) || StringUtils.isEmpty(password)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">400</span>, <span class="string">&quot;用户名或密码不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.查询用户</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userDTO = userClient.queryUserByUsernameAndPassword(username, password);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FeignException e) &#123;</span><br><span class="line">            <span class="comment">// 捕捉feign的异常，并获取feign调用状态码和异常信息</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(e.status(), e.contentUTF8(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.判断查询结果</span></span><br><span class="line">        <span class="keyword">if</span> (userDTO == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">400</span>, <span class="string">&quot;用户名或密码错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.生成token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jti</span> <span class="operator">=</span> JwtUtils.createJTI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtUtils.generateTokenWithJTI(<span class="keyword">new</span> <span class="title class_">UserInfo</span>(userDTO.getId(), username, <span class="literal">null</span>)</span><br><span class="line">                , jti, jwtProperties.getPrivateKey());</span><br><span class="line">        <span class="comment">// 4.将jti存入redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(BaseRedisConstants.JTI_KEY_PREFIX + userDTO.getId(), jti,</span><br><span class="line">                BaseRedisConstants.TOKEN_EXPIRE_MINUTES, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">// 5.写入cookie</span></span><br><span class="line">        <span class="comment">// &quot;/&quot;代表一切路径都有效</span></span><br><span class="line">        CookieUtils.builder(response)</span><br><span class="line">                .domain(DOMAIN)</span><br><span class="line">                .maxAge(-<span class="number">1</span>)</span><br><span class="line">                .path(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                .httpOnly(<span class="literal">true</span>)</span><br><span class="line">                .build(COOKIE_NAME, token);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">verify</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.获取cookie</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> CookieUtils.getCookieValue(request, COOKIE_NAME);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">401</span>, <span class="string">&quot;用户未登录或者超时&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.验证cookie的正确性</span></span><br><span class="line">        Payload&lt;UserInfo&gt; payload = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            payload = JwtUtils.getInfoFromToken(token, jwtProperties.getPublicKey(), UserInfo.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">401</span>, <span class="string">&quot;用户未登录或者不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.获取cookie中的username</span></span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> payload.getUserInfo();</span><br><span class="line">        <span class="keyword">if</span> (userInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">401</span>, <span class="string">&quot;用户未登录或者不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jti</span> <span class="operator">=</span> redisTemplate.opsForValue().get(BaseRedisConstants.JTI_KEY_PREFIX + userInfo.getId());</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.equals(jti, payload.getId())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">401</span>, <span class="string">&quot;登录失效&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userInfo.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//将redis中token删除</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> CookieUtils.getCookieValue(request, COOKIE_NAME);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">400</span>, <span class="string">&quot;未知错误,未登录不该点到这个按钮&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Payload&lt;UserInfo&gt; payload = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                payload = JwtUtils.getInfoFromToken(token, jwtProperties.getPublicKey(), UserInfo.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">400</span>, <span class="string">&quot;不存在token?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//3.获取cookie中的username</span></span><br><span class="line">            <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> payload.getUserInfo();</span><br><span class="line">            <span class="keyword">if</span> (userInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">400</span>, <span class="string">&quot;未知错误,未登录不该点到这个按钮&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            redisTemplate.delete(BaseRedisConstants.JTI_KEY_PREFIX + userInfo.getId());</span><br><span class="line">            <span class="comment">//将cookie时间设置为0</span></span><br><span class="line">            CookieUtils.deleteCookie(COOKIE_NAME, DOMAIN, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LyException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">400</span>, <span class="string">&quot;未知错误,未登录不该点到这个按钮&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">500</span>, <span class="string">&quot;退出登录失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//controller</span></span><br><span class="line"><span class="keyword">package</span> com.leyou.auth.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.service.UserAuthService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-06-06 9:31 下午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAuthController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserAuthService service;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserAuthController</span><span class="params">(UserAuthService service)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.service = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 无</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username,</span></span><br><span class="line"><span class="params">                                      <span class="meta">@RequestParam(&quot;password&quot;)</span> String password,</span></span><br><span class="line"><span class="params">                                      HttpServletResponse response)</span> &#123;</span><br><span class="line">        service.login(username, password, response);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.noContent().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/verify&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">verify</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> service.verify(request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/logout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        service.logout(request, response);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.noContent().build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="订单服务获取登陆用户信息实现"><a href="#订单服务获取登陆用户信息实现" class="headerlink" title="订单服务获取登陆用户信息实现"></a>订单服务获取登陆用户信息实现</h2><p>本项目采用系统设计的方案二：自己从cookie的token中解析用户信息，这种方案很安全。</p>
<p>ThreadLocal让用户与每一个请求线程绑定：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120508.png" alt="image-20210704030245597"></p>
<p>关键代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-06-08 9:52 上午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHolder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Long&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setUser</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">        tl.set(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">getUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> tl.get();</span><br><span class="line">        <span class="keyword">if</span>(id == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeUser</span><span class="params">()</span>&#123;</span><br><span class="line">        tl.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//mvc拦截器</span></span><br><span class="line"><span class="keyword">package</span> com.leyou.trade.interceptors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.common.constants.BaseTokenConstants;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.Payload;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.exception.LyException;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.CookieUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.utils.UserHolder;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-06-08 9:58 上午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取cookie中的token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> CookieUtils.getCookieValue(request, BaseTokenConstants.COOKIE_NAME);</span><br><span class="line">        <span class="comment">// 获取token中的用户, 不需要公钥或私钥，直接解析载荷</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Payload&lt;UserInfo&gt; payload = JwtUtils.getInfoFromToken(token, UserInfo.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> payload.getUserInfo();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存用户</span></span><br><span class="line">            UserHolder.setUser(userInfo.getId());</span><br><span class="line">            <span class="comment">// 放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="comment">// 获取用户失败，无需向后走了</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">500</span>, <span class="string">&quot;解析用户信息失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> &#123;</span><br><span class="line">        <span class="comment">// 业务结束后，移除ThreadLocal中的用户</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="分布式事务实现"><a href="#分布式事务实现" class="headerlink" title="分布式事务实现"></a>分布式事务实现</h2><p>采用Seata解决方案，开启一个seata服务，将两个配置文件放到resource目录下</p>
<p>引入seata依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在分布式事务开启的方法上使用Globaltransaction注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@GlobalTransactional</span></span><br><span class="line">   <span class="keyword">public</span> Long <span class="title function_">createOrder</span><span class="params">(OrderFormDTO orderFormDTO)</span> &#123;</span><br><span class="line">       <span class="comment">// 1.订单</span></span><br><span class="line">       <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">       <span class="comment">// 1.1.订单金额信息，包括：商品总金额、实付金额、邮费</span></span><br><span class="line">       Map&lt;Long, Integer&gt; carts = orderFormDTO.getCarts();</span><br><span class="line">       <span class="comment">// a.获取sku的id集合</span></span><br><span class="line">       Set&lt;Long&gt; ids = carts.keySet();</span><br><span class="line">       <span class="comment">// b.根据sku的id查询sku</span></span><br><span class="line">       List&lt;SkuDTO&gt; skuList = itemClient.querySkuByIds(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(ids));</span><br><span class="line">       <span class="comment">// c.计算总金额</span></span><br><span class="line">       <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">       <span class="keyword">for</span> (SkuDTO sku : skuList) &#123;</span><br><span class="line">           <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> carts.get(sku.getId());</span><br><span class="line">           total += sku.getPrice() * num;</span><br><span class="line">       &#125;</span><br><span class="line">       order.setTotalFee(total);</span><br><span class="line">       order.setPostFee(<span class="number">0L</span>);</span><br><span class="line">       order.setActualFee(order.getTotalFee() + order.getPostFee()<span class="comment">/*TODO 减去优惠金额*/</span>);</span><br><span class="line">       order.setPaymentType(orderFormDTO.getPaymentType());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 1.2.用户</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">       order.setUserId(userId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 1.3.状态</span></span><br><span class="line">       order.setStatus(OrderStatus.INIT);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 1.4.写入数据库</span></span><br><span class="line">       <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(order);</span><br><span class="line">       <span class="keyword">if</span> (!isSuccess) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">500</span>, <span class="string">&quot;新增订单失败！&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> order.getOrderId();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 2.订单详情</span></span><br><span class="line">       List&lt;OrderDetail&gt; orderDetails = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(skuList.size());</span><br><span class="line">       <span class="comment">// 2.1.把sku集合封装成OrderDetail集合</span></span><br><span class="line">       <span class="keyword">for</span> (SkuDTO sku : skuList) &#123;</span><br><span class="line">           <span class="type">OrderDetail</span> <span class="variable">detail</span> <span class="operator">=</span> buildOrderDetailFromSku(sku, orderId, carts.get(sku.getId()));</span><br><span class="line">           orderDetails.add(detail);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 2.2.写入数据库</span></span><br><span class="line">       detailService.saveBatch(orderDetails);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 3.物流</span></span><br><span class="line">       <span class="comment">// 3.1.获取地址的id</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">addressId</span> <span class="operator">=</span> orderFormDTO.getAddressId();</span><br><span class="line">       <span class="comment">// 3.2.根据id查询地址</span></span><br><span class="line">       <span class="type">AddressDTO</span> <span class="variable">address</span> <span class="operator">=</span> userClient.queryAddressById(addressId);</span><br><span class="line">       <span class="comment">// 判断当前地址是否属于当前用户</span></span><br><span class="line">      <span class="comment">/* if(!Objects.equals(address.getUserId(), userId))&#123;</span></span><br><span class="line"><span class="comment">           // 地址不属于当前用户，数据有误</span></span><br><span class="line"><span class="comment">           throw new LyException(400, &quot;请不要瞎搞，收货地址不是你的！&quot;);</span></span><br><span class="line"><span class="comment">       &#125;*/</span></span><br><span class="line">       <span class="comment">// 3.3.封装OrderLogistics，从address中拷贝属性到OrderLogistics</span></span><br><span class="line">       <span class="type">OrderLogistics</span> <span class="variable">orderLogistics</span> <span class="operator">=</span> address.toEntity(OrderLogistics.class);</span><br><span class="line">       orderLogistics.setOrderId(orderId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 3.4.写入数据库</span></span><br><span class="line">       isSuccess = logisticsService.save(orderLogistics);</span><br><span class="line">       <span class="keyword">if</span> (!isSuccess) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(<span class="number">500</span>, <span class="string">&quot;新增订单失败！&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 4.减库存</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           itemClient.deductStock(carts);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (FeignException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LyException</span>(e.status(), e.contentUTF8());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 5.发送延迟消息到交换机</span></span><br><span class="line">       amqpTemplate.convertAndSend(ORDER_EXCHANGE_NAME, EVICT_ORDER_KEY, orderId);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> orderId;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="微信支付实现"><a href="#微信支付实现" class="headerlink" title="微信支付实现"></a>微信支付实现</h2><p>部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.wxpay.sdk.WXPay;</span><br><span class="line"><span class="keyword">import</span> com.github.wxpay.sdk.WXPayConfigImpl;</span><br><span class="line"><span class="keyword">import</span> com.github.wxpay.sdk.WXPayConstants;</span><br><span class="line"><span class="keyword">import</span> com.github.wxpay.sdk.WXPayUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.trade.constants.PayConstants.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 虎哥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WXPay wxPay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WXPayConfigImpl payConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PayHelper</span><span class="params">(WXPay wxPay, WXPayConfigImpl payConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.wxPay = wxPay;</span><br><span class="line">        <span class="built_in">this</span>.payConfig = payConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">unifiedOrder</span><span class="params">(Long orderId, Long totalFee)</span>&#123;</span><br><span class="line">        <span class="comment">// 1.准备请求参数：</span></span><br><span class="line">        Map&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        <span class="comment">// 商品描述</span></span><br><span class="line">        data.put(<span class="string">&quot;body&quot;</span>, ORDER_DESC);</span><br><span class="line">        <span class="comment">// 商家的订单编号</span></span><br><span class="line">        data.put(ORDER_NO_KEY, orderId.toString());</span><br><span class="line">        <span class="comment">// 支付总金额，单位是分</span></span><br><span class="line">        data.put(TOTAL_FEE_KEY, totalFee.toString());</span><br><span class="line">        <span class="comment">// 终端IP：当前请求发起者的IP</span></span><br><span class="line">        data.put(<span class="string">&quot;spbill_create_ip&quot;</span>, payConfig.getSpbillCreateIp());</span><br><span class="line">        <span class="comment">// 此处指定为扫码支付</span></span><br><span class="line">        data.put(<span class="string">&quot;trade_type&quot;</span>, UNIFIED_ORDER_TRADE_TYPE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2.下单，得到结果</span></span><br><span class="line">            Map&lt;String, String&gt; resp = wxPay.unifiedOrder(data);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.验证签名</span></span><br><span class="line">            isSignatureValid(resp);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.校验return_code</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;FAIL&quot;</span>.equals(resp.get(<span class="string">&quot;return_code&quot;</span>)))&#123;</span><br><span class="line">                <span class="comment">// 业务失败，抛出异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;业务执行失败！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5.校验result_code</span></span><br><span class="line">            isResultSuccess(resp);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6.获取支付链接</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> resp.get(PAY_URL_KEY);</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isBlank(url))&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;支付链接为空！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> url;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;统一下单失败! &quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">isResultSuccess</span><span class="params">(Map&lt;String, String&gt; resp)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;FAIL&quot;</span>.equals(resp.get(<span class="string">&quot;result_code&quot;</span>)))&#123;</span><br><span class="line">            <span class="comment">// 业务失败，抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;业务执行失败！&quot;</span> + resp.get(<span class="string">&quot;err_code_des&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">isSignatureValid</span><span class="params">(Map&lt;String, String&gt; data)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isValid</span> <span class="operator">=</span> WXPayUtil.isSignatureValid(data, payConfig.getKey(), WXPayConstants.SignType.HMACSHA256);</span><br><span class="line">            <span class="keyword">if</span>(!isValid)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;签名无效&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;签名错误，无效数据！&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="订单清理实现"><a href="#订单清理实现" class="headerlink" title="订单清理实现"></a>订单清理实现</h2><p>配置队列和交换机：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.ExchangeConstants.DEAD_EXCHANGE_NAME;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.ExchangeConstants.ORDER_EXCHANGE_NAME;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.QueueConstants.DEAD_ORDER_QUEUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.QueueConstants.EVICT_ORDER_QUEUE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.BaseMQConstants.RoutingKeyConstants.EVICT_ORDER_KEY;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Huang Mingwang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2021-06-13 11:19 下午</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="comment">// 30分钟</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ORDER_QUEUE_DELAY_TIME</span> <span class="operator">=</span> <span class="number">30000</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ly-order-exchange 普通任务交换机，将消息转发到死信队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TopicExchange <span class="title function_">orderExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(ORDER_EXCHANGE_NAME, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ly-dead-exchange 死信交换机，接收死信队列转过来的消息，并投递给任务队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TopicExchange <span class="title function_">deadExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(DEAD_EXCHANGE_NAME, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deadOrderQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// x-message-ttl 声明队列TTL值</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, ORDER_QUEUE_DELAY_TIME);</span><br><span class="line">        <span class="comment">// x-dead-letter-exchange 声明当前队列绑定的死信交换机</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_EXCHANGE_NAME);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(DEAD_ORDER_QUEUE).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">evictOrderQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(EVICT_ORDER_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将死信队列与ly.order.exchange交换机绑定</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingDeadQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(deadOrderQueue()).to(orderExchange()).with(EVICT_ORDER_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把死信交换机与ly.evict.order.queue绑定</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingEvictQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(evictOrderQueue()).to(deadExchange()).with(EVICT_ORDER_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JSON的消息转换器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Jackson2JsonMessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>监听MQ消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.leyou.common.constants.MQConstants.QueueConstants.EVICT_ORDER_QUEUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderListener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderListener</span><span class="params">(OrderService orderService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderService = orderService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听清理订单的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId 订单id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = EVICT_ORDER_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenOrderMessage</span><span class="params">(Long orderId)</span> <span class="keyword">throws</span> InterruptedException 	 &#123;</span><br><span class="line">        <span class="keyword">if</span>(orderId != <span class="literal">null</span>)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;接收到订单任务，订单id：&#123;&#125;&quot;</span>, orderId);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                orderService.evictOrderIfNecessary(orderId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>清理订单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evictOrderIfNecessary</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.查询订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> getById(orderId);</span><br><span class="line">    <span class="keyword">if</span>(order == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">// 订单不存在，无需处理</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.判断订单是否支付</span></span><br><span class="line">    <span class="keyword">if</span>(order.getStatus() != OrderStatus.INIT)&#123;</span><br><span class="line">        <span class="comment">// 订单已处理，无需重复处理</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.如果未支付，需要关闭订单</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">boo</span> <span class="operator">=</span> update().set(<span class="string">&quot;status&quot;</span>, OrderStatus.CLOSED.getValue())</span><br><span class="line">        .set(<span class="string">&quot;close_time&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">        .eq(<span class="string">&quot;order_id&quot;</span>, orderId)</span><br><span class="line">        <span class="comment">// 通过乐观锁进一步保证幂等效果</span></span><br><span class="line">        .eq(<span class="string">&quot;status&quot;</span>, OrderStatus.INIT.getValue())</span><br><span class="line">        <span class="comment">// 执行update</span></span><br><span class="line">        .update();</span><br><span class="line">    <span class="keyword">if</span>(!boo)&#123;</span><br><span class="line">        <span class="comment">// 更新失败，订单状态已经改变，无需处理</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;已关闭超时未支付订单：&#123;&#125;&quot;</span>, orderId);</span><br><span class="line">    <span class="comment">// 4.查询OrderDetail</span></span><br><span class="line">    List&lt;OrderDetail&gt; details = detailService.query().eq(<span class="string">&quot;order_id&quot;</span>, orderId).list();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.获取商品及商品数量信息</span></span><br><span class="line">    Map&lt;Long, Integer&gt; map = details.stream()</span><br><span class="line">        .collect(Collectors.toMap(OrderDetail::getSkuId, OrderDetail::getNum));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.恢复库存</span></span><br><span class="line">    itemClient.addStock(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="前台门户主要页面展示"><a href="#前台门户主要页面展示" class="headerlink" title="前台门户主要页面展示"></a>前台门户主要页面展示</h2><p>登陆界面：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120509.png" alt="登陆">注册界面：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120510.png" alt="注册"></p>
<p>首页：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120511.png" alt="首页"></p>
<p>搜索结果页：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120512.png" alt="搜索结果页"></p>
<p>商品详情页：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120513.png" alt="商品详情页"></p>
<p>购物车页面：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120514.png" alt="购物车"></p>
<p>结算页：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120515.png" alt="结算页"></p>
<p>微信支付页：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120516.png" alt="微信支付页"></p>
<p>支付成功页：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120517.png" alt="支付成功页"></p>
<h2 id="管理员主要页面展示"><a href="#管理员主要页面展示" class="headerlink" title="管理员主要页面展示"></a>管理员主要页面展示</h2><p>登陆页：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120518.png" alt="管理员登陆页"></p>
<p>规格参数：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120519.png" alt="规格参数"></p>
<p>品牌管理：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120520.png" alt="品牌管理"></p>
<h2 id="分布式日志服务GrayLog页面展示"><a href="#分布式日志服务GrayLog页面展示" class="headerlink" title="分布式日志服务GrayLog页面展示"></a>分布式日志服务GrayLog页面展示</h2><p>日志统计：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120521.png" alt="截屏2021-07-04 上午3.57.06 (2)"></p>
<p>DashBoard页面：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120522.png" alt="截屏2021-07-04 上午4.00.20 (2)"></p>
<p>DashBoard页面：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120523.png" alt="image-20210704040232327"></p>
<h2 id="链路追踪SkyWalking"><a href="#链路追踪SkyWalking" class="headerlink" title="链路追踪SkyWalking"></a>链路追踪SkyWalking</h2><p>仪表盘页面：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120524.png" alt="截屏2021-07-04 上午3.53.43 (2)"></p>
<p>链路追踪页面：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120525.png" alt="截屏2021-07-04 上午3.55.44 (2)"></p>
<p>微服务拓扑图：</p>
<p><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202112212120526.png" alt="截屏2021-07-04 上午3.55.16 (2)"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">MingwHuang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://mingwzi.cn/2021/12/21/leyou/%E5%9F%BA%E4%BA%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%B1%BB%E4%BA%AC%E4%B8%9C%E5%B9%B3%E5%8F%B0%E7%BB%93%E9%A2%98%E6%8A%A5%E5%91%8A%20/">http://mingwzi.cn/2021/12/21/leyou/%E5%9F%BA%E4%BA%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%B1%BB%E4%BA%AC%E4%B8%9C%E5%B9%B3%E5%8F%B0%E7%BB%93%E9%A2%98%E6%8A%A5%E5%91%8A%20/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://mingwzi.cn" target="_blank">MingwHuang's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Leyou/">Leyou</a></div><div class="post_share"><div class="social-share" data-image="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046012.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202172251674.png" target="_blank"><img class="post-qr-code-img" src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202172251674.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202172251973.png" target="_blank"><img class="post-qr-code-img" src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202172251973.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/22/%E5%A4%A7%E6%95%B0%E6%8D%AE/Lab-1%20Hadoop%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/"><img class="prev-cover" src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046990.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Lab-1 Hadoop环境安装</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/21/Chaos/Design%20Doc%20Readability/"><img class="next-cover" src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046348.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Design Doc Readability</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/12/21/leyou/Java%E6%A1%86%E6%9E%B6/" title="Spring"><img class="cover" src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272047554.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-21</div><div class="title">Spring</div></div></a></div><div><a href="/2021/12/21/leyou/Leyou%E7%AC%94%E8%AE%B0/" title="leyou项目搭建"><img class="cover" src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046348.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-21</div><div class="title">leyou项目搭建</div></div></a></div><div><a href="/2021/12/21/leyou/leyou%E9%9D%A2%E8%AF%95%E7%89%88/" title="leyou常见问题"><img class="cover" src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272047300.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-21</div><div class="title">leyou常见问题</div></div></a></div><div><a href="/2021/12/21/leyou/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3%E9%9D%A2%E8%AF%95%E9%A2%98%E6%B1%87%E6%80%BB/" title="项目相关面试题"><img class="cover" src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046348.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-21</div><div class="title">项目相关面试题</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272113875.JPG" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">MingwHuang</div><div class="author-info__description">朝花夕拾 聊以记之</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/HuangMingwang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1125385880@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">网站域名：http://mingwzi.cn</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%B1%BB%E4%BA%AC%E4%B8%9C%E7%94%B5%E5%95%86%E5%B9%B3%E5%8F%B0%E7%BB%93%E9%A2%98%E6%8A%A5%E5%91%8A"><span class="toc-number">1.</span> <span class="toc-text">基于微服务架构的类京东电商平台结题报告</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%BB%AA%E8%AE%BA"><span class="toc-number">2.</span> <span class="toc-text">一、绪论</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.</span> <span class="toc-text">二、相关技术介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot"><span class="toc-number">3.1.</span> <span class="toc-text">Spring Boot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cloud"><span class="toc-number">3.2.</span> <span class="toc-text">Spring Cloud</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mybatis-Plus"><span class="toc-number">3.3.</span> <span class="toc-text">Mybatis Plus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL"><span class="toc-number">3.4.</span> <span class="toc-text">MySQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis"><span class="toc-number">3.5.</span> <span class="toc-text">Redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB"><span class="toc-number">3.6.</span> <span class="toc-text">MongoDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch"><span class="toc-number">3.7.</span> <span class="toc-text">ElasticSearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">3.8.</span> <span class="toc-text">RabbitMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx"><span class="toc-number">3.9.</span> <span class="toc-text">Nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Openresty"><span class="toc-number">3.10.</span> <span class="toc-text">Openresty</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT"><span class="toc-number">3.11.</span> <span class="toc-text">JWT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Canal"><span class="toc-number">3.12.</span> <span class="toc-text">Canal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata"><span class="toc-number">3.13.</span> <span class="toc-text">Seata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker"><span class="toc-number">3.14.</span> <span class="toc-text">Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GrayLog"><span class="toc-number">3.15.</span> <span class="toc-text">GrayLog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Skywalking"><span class="toc-number">3.16.</span> <span class="toc-text">Skywalking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue-js"><span class="toc-number">3.17.</span> <span class="toc-text">Vue.js</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue-CLI-%E8%84%9A%E6%89%8B%E6%9E%B6"><span class="toc-number">3.18.</span> <span class="toc-text">Vue CLI 脚手架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#element-UI-Vant-%E7%BB%84%E4%BB%B6%E5%BA%93"><span class="toc-number">3.19.</span> <span class="toc-text">element-UI + Vant 组件库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Axios"><span class="toc-number">3.20.</span> <span class="toc-text">Axios</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue-Router"><span class="toc-number">3.21.</span> <span class="toc-text">Vue Router</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vuex"><span class="toc-number">3.22.</span> <span class="toc-text">Vuex</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">三、需求分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%A1%B9%E7%9B%AE%E4%B8%BB%E8%A6%81%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.</span> <span class="toc-text">四、项目主要模块设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.1.</span> <span class="toc-text">项目总体结构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E5%BA%94%E7%94%A8%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.2.</span> <span class="toc-text">前台应用详细设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E9%97%A8%E6%88%B7%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.2.1.</span> <span class="toc-text">前台门户服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">技术栈:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">项目功能模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A6%96%E9%A1%B5%E5%B1%95%E7%A4%BA"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">首页展示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%A6%E5%8F%B7%E7%AE%A1%E7%90%86%E2%80%93%E5%BE%85%E5%8F%91%E8%B4%A7"><span class="toc-number">5.2.1.4.</span> <span class="toc-text">账号管理–待发货</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%A6%E5%8F%B7%E7%AE%A1%E7%90%86%E2%80%93%E6%88%91%E7%9A%84%E6%94%B6%E8%97%8F"><span class="toc-number">5.2.1.5.</span> <span class="toc-text">账号管理–我的收藏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF%E2%80%93%E5%9C%B0%E5%9D%80%E7%AE%A1%E7%90%86"><span class="toc-number">5.2.1.6.</span> <span class="toc-text">个人信息–地址管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD%E9%97%A8%E6%8E%A8%E8%8D%90%EF%BC%9A%E5%B0%86%E7%94%A8%E6%88%B7%E5%8F%AF%E8%83%BD%E5%96%9C%E6%AC%A2%E7%9A%84%E4%BA%A7%E5%93%81%E5%B1%95%E7%A4%BA%E5%9C%A8%E7%94%A8%E6%88%B7%E6%8E%A8%E8%8D%90%E5%88%97%E8%A1%A8%E4%B8%AD"><span class="toc-number">5.2.1.7.</span> <span class="toc-text">热门推荐：将用户可能喜欢的产品展示在用户推荐列表中</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E9%A1%B5%E9%9D%A2%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.2.2.</span> <span class="toc-text">管理员页面服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E9%A1%B5%E9%9D%A2%E6%9C%8D%E5%8A%A1%E9%87%87%E7%94%A8%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91%EF%BC%8C%E4%B8%BB%E8%A6%81%E5%AE%8C%E6%88%90%E7%9A%84%E5%8A%9F%E8%83%BD%E6%9C%89%EF%BC%9A"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">管理员页面服务采用前后端分离开发，主要完成的功能有：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B5%E5%95%86%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%9F%BA%E4%BA%8EVue-%E6%8A%80%E6%9C%AF%E6%A0%88%E7%9A%84-SPA-%E5%8D%95%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%85%B1-15-%E4%B8%AA%E5%85%B7%E6%9C%89%E4%BA%A4%E4%BA%92%E5%8A%9F%E8%83%BD%E7%9A%84%E9%A1%B5%E9%9D%A2%E3%80%82"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">电商后台管理系统是基于Vue 技术栈的 SPA 单页面应用项目，共 15 个具有交互功能的页面。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">主要技术栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E9%99%86%E5%8A%9F%E8%83%BD"><span class="toc-number">5.2.2.4.</span> <span class="toc-text">登陆功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">5.2.2.5.</span> <span class="toc-text">商品管理功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%9A%E5%91%98%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">5.2.2.6.</span> <span class="toc-text">会员管理功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%80%E5%94%AE%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">5.2.2.7.</span> <span class="toc-text">销售管理功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">5.2.2.8.</span> <span class="toc-text">权限管理功能</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E6%9C%8D%E5%8A%A1%E8%AF%A6%E7%BB%86%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.3.</span> <span class="toc-text">后台服务详细设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%85%A5%E5%B1%82"><span class="toc-number">5.3.1.</span> <span class="toc-text">接入层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">5.3.2.</span> <span class="toc-text">注册中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E5%B1%82"><span class="toc-number">5.3.3.</span> <span class="toc-text">网关层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="toc-number">5.3.4.</span> <span class="toc-text">服务层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%88ly-user-service%EF%BC%89"><span class="toc-number">5.3.4.1.</span> <span class="toc-text">用户微服务（ly-user-service）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-ly-item-service"><span class="toc-number">5.3.4.2.</span> <span class="toc-text">商品微服务(ly-item-service)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E5%BE%AE%E6%9C%8D%E5%8A%A1-ly-page"><span class="toc-number">5.3.4.3.</span> <span class="toc-text">商品详情页微服务(ly-page)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E4%B8%80%EF%BC%9A%E4%BC%A0%E7%BB%9F%E6%96%B9%E6%A1%88"><span class="toc-number">5.3.4.3.1.</span> <span class="toc-text">设计思路一：传统方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E4%BA%8C%EF%BC%9A%E5%8A%A0%E5%85%A5%E7%BC%93%E5%AD%98"><span class="toc-number">5.3.4.3.2.</span> <span class="toc-text">设计思路二：加入缓存</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E4%B8%89%EF%BC%9A%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">5.3.4.3.3.</span> <span class="toc-text">设计思路三：页面静态化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E5%9B%9B%EF%BC%9A%E5%8A%A8%E6%80%81%E6%A8%A1%E7%89%88%EF%BC%8C%E9%9D%99%E6%80%81%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-number">5.3.4.3.4.</span> <span class="toc-text">设计方案四：动态模版，静态化数据</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1-ly-search"><span class="toc-number">5.3.4.4.</span> <span class="toc-text">搜索微服务(ly-search)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E5%BE%AE%E6%9C%8D%E5%8A%A1-ly-trade"><span class="toc-number">5.3.4.5.</span> <span class="toc-text">交易微服务(ly-trade)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">5.3.4.5.1.</span> <span class="toc-text">获取用户思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E9%A1%B5%E9%9D%A2%E7%9B%B4%E6%8E%A5%E6%8A%8A%E7%94%A8%E6%88%B7%E4%BD%9C%E4%B8%BA%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92"><span class="toc-number">5.3.4.5.1.1.</span> <span class="toc-text">设计方案一：页面直接把用户作为请求参数传递</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E8%87%AA%E5%B7%B1%E4%BB%8Ecookie%E7%9A%84token%E4%B8%AD%E8%A7%A3%E6%9E%90%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">5.3.4.5.1.2.</span> <span class="toc-text">设计方案二：自己从cookie的token中解析用户信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.3.4.6.</span> <span class="toc-text">订单数据结构设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.3.4.7.</span> <span class="toc-text">分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%A8%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">5.3.4.7.1.</span> <span class="toc-text">跨数据源</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.4.7.2.</span> <span class="toc-text">跨服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">5.3.4.7.3.</span> <span class="toc-text">分布式系统数据一致性问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9ATCC"><span class="toc-number">5.3.4.7.4.</span> <span class="toc-text">设计方案一：TCC</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.4.7.4.1.</span> <span class="toc-text">设计方案二：消息服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E7%8B%AC%E7%AB%8B%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.4.7.4.2.</span> <span class="toc-text">设计方案三：独立消息服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9ASeata"><span class="toc-number">5.3.4.7.4.3.</span> <span class="toc-text">设计方案三：Seata</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98"><span class="toc-number">5.3.4.7.5.</span> <span class="toc-text">微信支付</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%B8%85%E7%90%86"><span class="toc-number">5.3.4.7.6.</span> <span class="toc-text">订单清理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.5.</span> <span class="toc-text">基础服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%AD%E4%BF%A1%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.5.1.</span> <span class="toc-text">短信微服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.5.2.</span> <span class="toc-text">权限微服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.5.3.</span> <span class="toc-text">日志服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91OSS%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.5.4.</span> <span class="toc-text">阿里云OSS服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%B1%82"><span class="toc-number">5.3.6.</span> <span class="toc-text">数据层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL-1"><span class="toc-number">5.3.6.1.</span> <span class="toc-text">MySQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Elasticsearch"><span class="toc-number">5.3.6.2.</span> <span class="toc-text">Elasticsearch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-1"><span class="toc-number">5.3.6.3.</span> <span class="toc-text">Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MongoDB-1"><span class="toc-number">5.3.6.4.</span> <span class="toc-text">MongoDB</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E9%A1%B9%E7%9B%AE%E4%B8%BB%E8%A6%81%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">五、项目主要模块实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">6.1.</span> <span class="toc-text">项目准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E6%8B%A9"><span class="toc-number">6.1.1.</span> <span class="toc-text">技术选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">6.1.2.</span> <span class="toc-text">项目开发环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="toc-number">6.1.3.</span> <span class="toc-text">项目测试环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">6.1.4.</span> <span class="toc-text">项目结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">6.2.</span> <span class="toc-text">ElasticSearch数据同步问题解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">6.2.1.</span> <span class="toc-text">商品微服务发送消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%97%E6%B6%88%E6%81%AF"><span class="toc-number">6.2.2.</span> <span class="toc-text">搜索微服务接受消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81%E9%9D%99%E6%80%81%E9%A1%B5%E5%AE%9E%E7%8E%B0%EF%BC%88%E5%A4%84%E7%90%86%E9%AB%98%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-number">6.3.</span> <span class="toc-text">商品静态页实现（处理高并发请求）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="toc-number">6.3.1.</span> <span class="toc-text">主要代码：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">6.3.2.</span> <span class="toc-text">优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Canal%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">6.3.3.</span> <span class="toc-text">Canal实现缓存数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="toc-number">6.3.3.1.</span> <span class="toc-text">关键代码：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT%E7%99%BB%E9%99%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.4.</span> <span class="toc-text">JWT登陆实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Token%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.4.1.</span> <span class="toc-text">Token失效问题具体实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96%E7%99%BB%E9%99%86%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.5.</span> <span class="toc-text">订单服务获取登陆用户信息实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.6.</span> <span class="toc-text">分布式事务实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.7.</span> <span class="toc-text">微信支付实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%B8%85%E7%90%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.8.</span> <span class="toc-text">订单清理实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E9%97%A8%E6%88%B7%E4%B8%BB%E8%A6%81%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA"><span class="toc-number">6.9.</span> <span class="toc-text">前台门户主要页面展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E4%B8%BB%E8%A6%81%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA"><span class="toc-number">6.10.</span> <span class="toc-text">管理员主要页面展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1GrayLog%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA"><span class="toc-number">6.11.</span> <span class="toc-text">分布式日志服务GrayLog页面展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AASkyWalking"><span class="toc-number">6.12.</span> <span class="toc-text">链路追踪SkyWalking</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/03/01/%E9%9D%A2%E8%AF%95/Linux/" title="Linux"><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046348.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux"/></a><div class="content"><a class="title" href="/2022/03/01/%E9%9D%A2%E8%AF%95/Linux/" title="Linux">Linux</a><time datetime="2022-03-01T15:08:28.000Z" title="发表于 2022-03-01 23:08:28">2022-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/01/%E9%9D%A2%E8%AF%95/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="设计模式"><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272047300.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式"/></a><div class="content"><a class="title" href="/2022/03/01/%E9%9D%A2%E8%AF%95/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="设计模式">设计模式</a><time datetime="2022-03-01T15:03:15.000Z" title="发表于 2022-03-01 23:03:15">2022-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/26/%E9%9D%A2%E8%AF%95/Redis/" title="Redis"><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046348.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis"/></a><div class="content"><a class="title" href="/2022/02/26/%E9%9D%A2%E8%AF%95/Redis/" title="Redis">Redis</a><time datetime="2022-02-26T06:21:50.000Z" title="发表于 2022-02-26 14:21:50">2022-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/25/K8S/" title="K8S"><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046164.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S"/></a><div class="content"><a class="title" href="/2022/02/25/K8S/" title="K8S">K8S</a><time datetime="2022-02-25T14:38:23.000Z" title="发表于 2022-02-25 22:38:23">2022-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/25/Chaos/Chaos/" title="Chaos"><img src="https://typora-mingwhuang.oss-cn-shenzhen.aliyuncs.com/typora/202202272046990.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Chaos"/></a><div class="content"><a class="title" href="/2022/02/25/Chaos/Chaos/" title="Chaos">Chaos</a><time datetime="2022-02-25T14:38:23.000Z" title="发表于 2022-02-25 22:38:23">2022-02-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By MingwHuang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><span class="footer-separator">|</span><a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备2022001353号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>